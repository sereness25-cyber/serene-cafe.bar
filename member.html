<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>会員ページ｜セレネス</title>

<!-- ✅ LIFF SDK（退会時ログアウトのために追加） -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{
  --bg:#fbf6f1;          /* 背景：やさしいベージュ */
  --card:#ffffff;
  --text:#3b352e;        /* 文字：ブラウン寄り */
  --muted:#7a6f63;       /* 補助文字 */
  --pri:#4f7cff;         /* メインボタン（青はそのままでOK） */
  --ok:#10b981;
  --danger:#ef4444;
  --line:#e9dfd6;        /* 罫線を少し柔らかく */
  --radius:28px;
  --shadow:0 14px 28px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",system-ui,sans-serif}
.wrap{max-width:980px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
h1{font-size:18px;margin:0}
.small{font-size:12px;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:860px){.grid{grid-template-columns:1.2fr .8fr}}

.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{
  border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;
  background:var(--pri);color:#fff
}
.btn.gray{background:#1118270d;color:var(--text);border:1px solid var(--line);font-weight:700}
.btn.danger{background:var(--danger)}
.badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}
.badge.ok{border-color:#bbf7d0;background:#ecfdf5;color:#065f46}
.badge.ng{border-color:#fecaca;background:#fff1f2;color:#9f1239}

input{
  width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);font-size:15px;
}
label{font-size:12px;color:var(--muted)}
hr{border:0;border-top:1px solid var(--line);margin:12px 0}
.notice{font-size:13px;color:var(--muted);line-height:1.8}
.err{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid #fecaca;background:#fff1f2;color:#9f1239;display:none}
.ok{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid #bbf7d0;background:#ecfdf5;color:#065f46;display:none}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div>
      <h1>会員ページ</h1>
      <div class="small" id="sub">読み込み中…</div>
    </div>
    <div class="row">
      <button class="btn danger" id="withdrawBtn">退会する</button>
      <button class="btn gray" id="logoutBtn">ログアウト</button>
    </div>
  </header>

  <div class="grid">

    <!-- 左：通常コンテンツ（電話番号登録が済んだら表示） -->
    <section class="card" id="mainArea" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <span class="badge ok" id="loginBadge">ログイン中</span>
          <span class="badge" id="memberIdBadge">ID: -</span>
        </div>
        <div class="row">
          <button class="btn" id="goProfileBtn">プロフィールを編集</button>
        </div>
      </div>

      <hr>

      <div class="notice">
        ここに会員向けのメニューを追加できます。<br>
        例）掲示板へ / 相性診断へ / イベント一覧へ など
      </div>
    </section>

    <!-- 右：電話番号補完フォーム（phoneが空なら表示） -->
    <aside class="card" id="phoneArea" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:900;">電話番号の登録</div>
        <span class="badge ng">未登録</span>
      </div>

      <div class="notice" style="margin-top:10px;">
        LINE連携だけだと電話番号が取得できないため、最初だけ入力してください。
      </div>

      <div style="margin-top:12px;">
        <label>電話番号（ハイフンなし推奨）</label>
        <input id="phoneInput" inputmode="numeric" placeholder="例）09012345678">
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="savePhoneBtn">保存する</button>
        <button class="btn gray" id="skipBtn" title="後で設定する">あとで</button>
      </div>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>
    </aside>

  </div>
</div>

<script>
/* =========================
 * 設定
 * ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";

/* ✅ あなたの「会員ページ」用 LIFF ID（分かれば入れる）
   - 不明なら空のままでOK（logout時に initしない運用にする）
*/
const MEMBER_LIFF_ID = ""; // 例）"2006846780-xxxx"

/* =========================
 * 共通
 * ========================= */
const sub = document.getElementById("sub");
const mainArea = document.getElementById("mainArea");
const phoneArea = document.getElementById("phoneArea");
const errBox = document.getElementById("errBox");
const okBox = document.getElementById("okBox");
const memberIdBadge = document.getElementById("memberIdBadge");

function showErr(msg){
  errBox.style.display="block";
  errBox.textContent=msg;
}
function showOk(msg){
  okBox.style.display="block";
  okBox.textContent=msg;
}
function hideMsg(){
  errBox.style.display="none";
  okBox.style.display="none";
  errBox.textContent="";
  okBox.textContent="";
}
function normPhone(v){
  return String(v||"").replace(/[^\d]/g,"");
}

/* ✅ storage全削除（退会/ログアウト共通で使う） */
function clearAuthStorage(){
  localStorage.removeItem("member_ok");
  localStorage.removeItem("member_id");
  // 登録ページで sessionStorage に保持してる場合もあるので消す
  sessionStorage.removeItem("tmp_name");
  sessionStorage.removeItem("tmp_age");
  sessionStorage.removeItem("tmp_phone");
}

/* ✅ LIFFログアウト（可能なら） */
async function liffLogoutIfPossible(){
  try{
    if(!window.liff) return;

    // MEMBER_LIFF_ID があるなら初期化を試す（失敗しても握りつぶす）
    if(MEMBER_LIFF_ID){
      try{ await liff.init({ liffId: MEMBER_LIFF_ID }); }catch(_){}
    }

    if(liff.isLoggedIn && liff.isLoggedIn()){
      liff.logout();
    }
  }catch(_){}
}

/* =========================
 * ログイン状態のチェック
 * ========================= */
const memberOk = localStorage.getItem("member_ok");
const memberId = localStorage.getItem("member_id");

if(memberOk !== "1" || !memberId){
  location.href = "login.html";
}

/* =========================
 * members を取得（phone確認用）
 * ========================= */
async function loadMember(){
  const url = `${SCRIPT_URL}?action=get_member&id=${encodeURIComponent(memberId)}&_=${Date.now()}`;
  const res = await fetch(url, { method:"GET", cache:"no-store" });
  const data = await res.json();
  if(!data.ok) throw new Error(data.error || "failed_get_member");
  return (data.member || {});
}

/* =========================
 * 表示切り替え
 * ========================= */
async function refreshUI(){
  memberIdBadge.textContent = "ID: " + memberId;

  const m = await loadMember();
  const phone = normPhone(m.phone || "");

  if(!phone){
    sub.textContent = "電話番号の登録が必要です";
    phoneArea.style.display = "block";
    mainArea.style.display = "none";
  }else{
    sub.textContent = "ようこそ";
    phoneArea.style.display = "none";
    mainArea.style.display = "block";
  }
}

/* 初期化 */
(async function init(){
  try{
    sub.textContent = "ログイン確認中…";
    await refreshUI();
  }catch(e){
    sub.textContent = "エラー";
    phoneArea.style.display = "block";
    showErr("読み込みに失敗しました。GASのURL・公開設定をご確認ください。");
  }
})();

/* =========================
 * 電話番号保存
 * ========================= */
document.getElementById("savePhoneBtn").addEventListener("click", async ()=>{
  hideMsg();
  const phone = normPhone(document.getElementById("phoneInput").value);

  if(phone.length < 10){
    showErr("電話番号を正しく入力してください。");
    return;
  }

  try{
    const url =
      `${SCRIPT_URL}?action=save_phone` +
      `&member_id=${encodeURIComponent(memberId)}` +
      `&phone=${encodeURIComponent(phone)}` +
      `&_=${Date.now()}`;

    const res = await fetch(url, { method:"GET", cache:"no-store" });
    const data = await res.json();

    if(data.ok){
      showOk("保存しました。");
      await refreshUI();
      return;
    }

    showErr("保存に失敗しました：" + (data.error || "unknown"));

  }catch(e){
    showErr("通信エラーが発生しました。");
  }
});

/* あとで（いったん通常画面へ） */
document.getElementById("skipBtn").addEventListener("click", ()=>{
  phoneArea.style.display = "none";
  mainArea.style.display = "block";
  sub.textContent = "※電話番号は未登録のままです（後で設定してください）";
});

/* プロフィールへ */
document.getElementById("goProfileBtn").addEventListener("click", ()=>{
  location.href = "profile.html";
});

/* ログアウト（※退会ではない） */
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  clearAuthStorage();
  // 通常ログアウトでは LIFF logout は任意（したければON）
  await liffLogoutIfPossible();
  location.replace("login.html");
});

/* =========================
 * 退会（withdraw）
 * - 成功したら storage削除 + LIFFログアウト + loginへ
 * ========================= */
document.getElementById("withdrawBtn").addEventListener("click", async ()=>{
  if(!confirm("本当に退会しますか？\nこの操作は取り消せません。")){
    return;
  }

  try{
    const url =
      `${SCRIPT_URL}?action=withdraw` +
      `&member_id=${encodeURIComponent(memberId)}` +
      `&_=${Date.now()}`;

    const res = await fetch(url, { method:"GET", cache:"no-store" });
    const data = await res.json();

    if(data.ok){
      clearAuthStorage();
      await liffLogoutIfPossible(); // ✅ 退会時は必ずLINEログアウトを試す
      alert("退会が完了しました。ご利用ありがとうございました。");
      location.replace("login.html");
      return;
    }

    alert("退会できませんでした：" + (data.error || "unknown"));

  }catch(e){
    alert("通信エラーが発生しました。");
  }
});
</script>
</body>
</html>