<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>新規登録（LINE連携）</title>

  <style>
    :root{
      --bg:#fbf7f2; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --line:#eee2d5; --pri:#d97706; --pri2:#b45309;
      --radius:14px; --shadow:0 10px 26px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif
    }
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
    .brand{font-weight:900}
    nav{display:flex;gap:8px}
    main{max-width:1100px;margin:0 auto;padding:18px 16px}
    h1{font-size:22px;margin:6px 0 14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .small{font-size:13px;color:var(--muted);line-height:1.6}
    .hr{height:1px;background:var(--line);margin:12px 0}
    label{display:block;margin:10px 0 6px;font-weight:800}
    input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .cols2{grid-template-columns:1fr}
    @media(min-width:720px){.cols2{grid-template-columns:1fr 1fr}}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.primary:hover{background:var(--pri2)}
    .okBox{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:12px}
    .doneBox{background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;border-radius:12px;padding:12px}
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script defer src="liff-config.js"></script>
  <script defer src="app.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brand">紹介サービス｜セレネス</div>
    <nav>
      <a class="btn" href="index.html">ホーム</a>
      <a class="btn" href="login.html">ログイン</a>
    </nav>
  </div>
</header>

<main>
  <h1>新規登録（LINE連携）</h1>

  <section class="card" style="max-width:760px">
    <div id="lineBox" class="okBox">LINE認証中…</div>

    <div class="hr"></div>

    <div class="small">
      <b>安心して利用していただくために</b><br>
      なりすまし防止のため、<b>面談での本人確認後に会員IDを発行</b>します。
      <ol>
        <li>新規登録（LINE連携＋入力）</li>
        <li>担当者からご連絡</li>
        <li>面談（対面 or オンライン）</li>
        <li>会員ID発行</li>
        <li>利用開始</li>
      </ol>
    </div>

    <form id="formRegister" style="display:none;margin-top:14px">
      <label>名前</label>
      <input id="name" required>

      <div class="grid cols2">
        <div>
          <label>年齢</label>
          <input id="age" type="number" min="18" max="99" required>
        </div>
        <div>
          <label>電話番号</label>
          <input id="phone" inputmode="tel" required>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn primary" type="submit">申請する</button>
        <a class="btn" href="index.html">戻る</a>
      </div>
    </form>

    <div id="doneBox" class="doneBox" style="display:none;margin-top:14px">
      <b>申請を受け付けました。</b><br>
      続けて公式LINEへ送信してください。
    </div>
  </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  const lineBox = document.getElementById("lineBox");
  const form = document.getElementById("formRegister");
  const doneBox = document.getElementById("doneBox");

  const nameEl  = document.getElementById("name");
  const ageEl   = document.getElementById("age");
  const phoneEl = document.getElementById("phone");

  const showError = (t)=>{
    lineBox.textContent = t;
    // デバッグしやすいように、最低フォームは出す
    if(form) form.style.display = "block";
  };

  try{
    // 1) LIFF初期化
    if(typeof initLIFF !== "function") return showError("app.js が読み込めていません（initLIFFが無い）");
    const r = await initLIFF();
    if(!r.ok) return showError(r.msg || "LIFF初期化に失敗しました");

    // 2) LINE未ログイン → ログインへ（400回避の安全URL）
    if(!liff.isLoggedIn()){
      const cleanUrl = location.origin + location.pathname;
      liff.login({ redirectUri: cleanUrl });
      return;
    }

    // 3) プロフィール取得
    const profile = await getLineProfileSafe();
    const lineUserId = profile.userId;

    lineBox.textContent = `LINE連携OK：${profile.displayName || "ユーザー"} さん。申請情報を入力してください。`;
    form.style.display = "block";

    // 4) 申請送信
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      const name  = (nameEl?.value || "").trim();
      const age   = (ageEl?.value || "").trim();
      const phone = (phoneEl?.value || "").trim();

      if(!name || !age || !phone){
        alert("名前・年齢・電話番号を入力してください");
        return;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      if(submitBtn) submitBtn.disabled = true;
      lineBox.textContent = "申請を送信しています…";

      // GASへ送信
      if(typeof gasApply !== "function"){
        alert("gasApply が見つかりません（app.jsの下部のGAS部分を確認）");
        if(submitBtn) submitBtn.disabled = false;
        return;
      }

      const res = await gasApply({
        lineUserId,
        displayName: profile.displayName || "",
        name, age, phone
      });

      if(!res || !res.ok){
        alert("申請送信に失敗しました。もう一度お試しください。");
        if(submitBtn) submitBtn.disabled = false;
        lineBox.textContent = "申請送信に失敗しました。";
        return;
      }

      // 受付表示
      form.style.display = "none";
      doneBox.style.display = "block";
      lineBox.textContent = "申請を受け付けました。続けて公式LINEへ送信してください。";

      // 公式LINEへ（自動入力はoaMessageのみ）
      const text =
`【セレネスカフェ&バー申請】
お名前：${name}
年齢：${age}
電話番号：${phone}`;

      const linEe = "https://lin.ee/oP0e2Kf";
      const oaMsg = `https://line.me/R/oaMessage/@820theos/?${encodeURIComponent(text)}`;

      // まず友だち追加（lin.ee）
      liff.openWindow({ url: linEe, external:true });

      // その後、文面入りトーク（oaMessage）
      setTimeout(()=> liff.openWindow({ url: oaMsg, external:true }), 900);

      // 審査中ページへ
      setTimeout(()=> location.replace("waiting.html"), 1800);
    });

  }catch(err){
    console.error(err);
    showError("エラーが発生しました。Safariの場合は一度ページを再読み込みしてください。");
  }
});
</script>
</body>
</html>