<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>新規登録（LINE連携）</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script defer src="liff-config.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">紹介サービス｜セレネス</div>
    <nav>
      <a class="btn ghost" href="index.html">ホーム</a>
      <a class="btn ghost" href="board.html">掲示板</a>
      <span data-auth class="row"></span>
    </nav>
  </div>
</header>

<main>
  <h1>新規登録（LINE連携）</h1>

  <section class="card" style="max-width:680px">
    <div id="lineBox" class="item">LINE認証中…</div>

    <form id="formRegister" style="display:none; margin-top:12px">
      <label>名前</label>
      <input id="name" required placeholder="例：竹内 圭" />

      <div class="grid cols2">
        <div>
          <label>年齢</label>
          <input id="age" type="number" min="18" max="99" required placeholder="例：35" />
        </div>
        <div>
          <label>電話番号</label>
          <input id="phone" required inputmode="tel" placeholder="例：09012345678" />
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn primary" type="submit">登録する</button>
        <a class="btn" href="index.html">戻る</a>
      </div>

      <p class="small" style="margin-top:10px">
        ※電話番号はLINEから取得できないため、入力していただきます。
      </p>
    </form>
  </section>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const lineBox = document.getElementById("lineBox");
  const form = document.getElementById("formRegister");

  const r = await ensureLineLogin();
  if(!r.ok) return;

  const profile = await getLineProfileSafe();
  const lineUserId = profile.userId;

  // 既に登録済みならログイン扱いで会員ページへ
  const existing = getMember(lineUserId);
  if(existing){
    setLineSession(lineUserId);
    location.href = "member.html";
    return;
  }

  lineBox.innerHTML = `
    <div><strong>LINE連携OK</strong></div>
    <div class="small">LINE表示名：${escapeHtml(profile.displayName || "")}</div>
  `;

  document.getElementById("name").value = profile.displayName || "";
  form.style.display = "block";

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    upsertMember({
      lineUserId,
      displayName: profile.displayName || "",
      name: document.getElementById("name").value.trim(),
      age: document.getElementById("age").value,
      phone: document.getElementById("phone").value.trim(),
      createdAt: new Date().toISOString()
    });
    setLineSession(lineUserId);
    alert("登録しました！");
    location.href = "member.html";
  });
});
</script>
</main>
</body>
</html>