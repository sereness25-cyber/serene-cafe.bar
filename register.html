<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>入店手続き｜セレネスCafe&Bar</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&family=Dancing+Script:wght@600&family=Zen+Kurenaido&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --wall: #e8e4dc;      /* 漆喰の壁色 */
      --brick: #d7ccc8;     /* レンガ色 */
      --wood: #4e342e;      /* 木枠・文字色 */
      --wood-light: #8d6e63;
      --paper: #f9f4ef;
      --accent: #a1887f;
      --glass: rgba(255, 255, 255, 0.85); /* ボード背景 */
      --light: rgba(255, 220, 180, 0.4);
      --btn-bg: #5d4037;
    }

    /* 夜モード */
    body[data-mode="bar"] { 
      --wall: #2b2623;
      --brick: #3e3733;
      --wood: #d7ccc8; /* 夜は文字を明るく */
      --wood-light: #4e3b31;
      --glass: rgba(30, 30, 30, 0.85);
      --light: rgba(255, 180, 100, 0.15);
      --btn-bg: #8d6e63;
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; font-family: "Shippori Mincho", serif;
      color: var(--wood); line-height: 1.8; transition: color 1s, background 1s;
      overflow-x: hidden; background: var(--wall); min-height: 100vh;
    }

    /* --- 外壁の表現 --- */
    .facade-bg {
      position: fixed; inset: 0; z-index: -2; pointer-events: none;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ0cmFuc3BhcmVudCIvPjxjaXJjbGUgY3g9IjEwIiBjeT0iMTAiIHI9IjEiIGZpbGw9InJnYmEoMCwwLDAsMC4wNSkiLz48L3N2Zz4=');
    }
    .brick-wall {
      position: fixed; bottom: 0; left: 0; right: 0; height: 15vh; z-index: -2;
      background-color: var(--brick);
      background-image: 
        linear-gradient(335deg, rgba(0,0,0,0.05) 23px, transparent 23px),
        linear-gradient(155deg, rgba(0,0,0,0.05) 23px, transparent 23px);
      background-size: 58px 58px;
      border-top: 8px solid #3e2723; /* 巾木 */
    }
    .street-light {
      position: fixed; top: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 800px; height: 60vh;
      background: radial-gradient(circle at 50% 0%, var(--light), transparent 70%);
      z-index: -1; pointer-events: none; mix-blend-mode: hard-light;
    }

    /* ヘッダー */
    header { 
      position: sticky; top: 0; z-index: 100; height: 70px; display: flex; align-items: center; padding: 0 20px;
      background: rgba(232, 228, 220, 0.95); /* 壁色に近い半透明 */
      backdrop-filter: blur(5px);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    body[data-mode="bar"] header { background: rgba(43, 38, 35, 0.95); border-bottom-color: rgba(255,255,255,0.1); }

    .wrap { width: 100%; max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .brand { font-size: 24px; font-family: 'Dancing Script', cursive; font-weight: 700; letter-spacing: 0.1em; }
    
    /* ★ チケット風ボタン */
    .btn.ghost { 
      border: 1px solid var(--wood); background: transparent; color: var(--wood); 
      padding: 6px 14px; border-radius: 4px; text-decoration: none; 
      font-size: 12px; font-family: "Shippori Mincho", serif; letter-spacing: 1px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2); transition: 0.3s; position: relative;
    }
    .btn.ghost::before, .btn.ghost::after {
      content: ""; position: absolute; top: 50%; width: 6px; height: 6px; 
      background: #e8e4dc; /* ヘッダー背景色と合わせる（昼） */
      border-radius: 50%; transform: translateY(-50%);
      border: 1px solid var(--wood);
    }
    .btn.ghost::before { left: -4px; border-right-color: transparent; }
    .btn.ghost::after { right: -4px; border-left-color: transparent; }

    body[data-mode="bar"] .btn.ghost::before, body[data-mode="bar"] .btn.ghost::after { 
        background: #2b2623; /* ヘッダー背景色と合わせる（夜） */
    }

    main { max-width: 600px; margin: 0 auto; padding: 40px 20px 80px; }

    h1 { 
      font-size: 22px; text-align: center; margin-bottom: 30px; letter-spacing: 0.2em; 
      font-family: 'Zen Kurenaido', sans-serif;
      text-shadow: 1px 1px 0 var(--wall);
    }

    /* 記帳台（メニューボード）風カード */
    .card {
      background: var(--glass); 
      border: 6px solid #5d4037; /* 木枠 */
      border-radius: 4px; padding: 30px 24px; position: relative;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    body[data-mode="bar"] .card { border-color: #3e2e28; }

    /* ボードの留め具 */
    .card::before {
      content: ""; position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
      width: 120px; height: 20px; background: #3e2723;
      border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .card::after {
      content: ""; position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
      width: 2px; height: 20px; background: #333; /* 吊り紐 */
    }

    .okBox {
      background: rgba(255,255,255,0.5); border: 1px dashed var(--accent);
      color: var(--wood); padding: 16px; text-align: center; font-size: 14px;
      margin-bottom: 24px; border-radius: 2px;
    }
    body[data-mode="bar"] .okBox { background: rgba(0,0,0,0.2); }

    .message-text {
      font-size: 14px; line-height: 1.9; margin-bottom: 24px;
    }
    
    ol.steps {
      padding-left: 0; list-style: none; counter-reset: step;
      border-left: 2px solid var(--accent); margin-left: 10px;
    }
    ol.steps li {
      position: relative; padding-left: 24px; margin-bottom: 16px; font-size: 14px;
    }
    ol.steps li::before {
      counter-increment: step; content: counter(step);
      position: absolute; left: -11px; top: 2px; width: 20px; height: 20px;
      background: var(--paper); border: 1px solid var(--accent); border-radius: 50%;
      text-align: center; line-height: 18px; font-size: 10px; color: var(--wood);
    }
    body[data-mode="bar"] ol.steps li::before { background: #3e3733; }

    .hr { height: 1px; background: var(--accent); margin: 30px 0; border: none; opacity: 0.3; }

    label { display: block; margin: 16px 0 6px; font-size: 13px; color: var(--accent); font-weight: bold; }
    input {
      width: 100%; padding: 10px; border: none; border-bottom: 1px solid var(--accent);
      background: transparent; font-size: 16px; font-family: "Shippori Mincho";
      color: var(--wood); outline: none; border-radius: 0; transition: 0.3s;
    }
    input:focus { border-bottom-color: var(--wood); background: rgba(255,255,255,0.1); }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    /* 木のボタン */
    .btn.primary {
      width: 100%; padding: 16px; background: var(--btn-bg); color: #fff;
      border: none; border-radius: 2px; font-family: "Shippori Mincho"; font-size: 16px;
      letter-spacing: 0.1em; cursor: pointer; 
      box-shadow: 0 4px 0 #3e2723, 0 5px 10px rgba(0,0,0,0.3);
      transition: 0.1s; position: relative; overflow: hidden; margin-top: 10px;
    }
    .btn.primary:active { transform: translateY(4px); box-shadow: 0 0 0 #3e2723, inset 0 2px 5px rgba(0,0,0,0.3); }
    .btn.primary:disabled { background: #a1887f; cursor: not-allowed; box-shadow: none; transform: none; }

    .agreeBox { margin: 24px 0; font-size: 12px; display: flex; gap: 8px; align-items: start; }
    .agreeLink { color: var(--wood); text-decoration: underline; }

    .hint { font-size: 11px; color: var(--accent); display: block; text-align: center; margin-top: 8px; }

  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script defer src="liff-config.js"></script>
  <script defer src="app.js"></script>
</head>

<body>
  <div class="facade-bg"></div>
  <div class="brick-wall"></div>
  <div class="street-light"></div>

  <header>
    <div class="wrap">
      <div class="brand">Reception</div>
      <nav>
        <a class="btn ghost" href="index.html">入口に戻る</a>
      </nav>
    </div>
  </header>

  <main>
    <h1>ご入店手続き</h1>

    <section class="card">
      <div id="lineBox" class="okBox">
        まずは、連絡先（LINE）をご提示ください。
      </div>

      <div class="message-text">
        <b>静かな時間を守るために</b><br>
        当店は会員制のカフェ＆バーです。<br>
        安心して過ごしていただくため、<b>簡単な面談（おしゃべり）のあとに会員証をお渡し</b>しています。
      </div>

      <ol class="steps">
        <li>受付票を記入（LINE連携）</li>
        <li>スタッフよりご挨拶のご連絡</li>
        <li>簡単な面談（本人確認）</li>
        <li>会員証の発行・ご入店</li>
      </ol>

      <div class="hr"></div>

      <div id="step1">
        <div style="text-align:center; margin-bottom:10px; font-family:'Dancing Script'; font-size:18px; color:var(--accent);">Step 1</div>
        <button class="btn primary" id="btnConnectLine" type="button">連絡先を提示する (LINE)</button>
        <span class="hint">※入力フォームが表示されます</span>
      </div>

      <form id="formRegister" style="display:none; margin-top:20px;">
        <div style="text-align:center; margin-bottom:20px; font-family:'Dancing Script'; font-size:18px; color:var(--accent);">Step 2</div>
        
        <label>お名前</label>
        <input id="name" required placeholder="例：山田 太郎" />

        <div class="grid">
          <div>
            <label>年齢</label>
            <input id="age" type="number" min="18" max="99" required placeholder="例：35" />
          </div>
          <div>
            <label>電話番号</label>
            <input id="phone" required inputmode="tel" placeholder="例：09012345678" />
          </div>
        </div>

        <div class="agreeBox">
          <input type="checkbox" id="agreeCheck">
          <label for="agreeCheck">
            <a href="legal.html" target="_blank" class="agreeLink">利用規約</a> および <a href="legal.html" target="_blank" class="agreeLink">プライバシーポリシー</a> を確認し、同意します。
          </label>
        </div>

        <button class="btn primary" id="btnApply" type="submit">扉をノックする（申請）</button>
        
        <p class="hint" style="margin-top:16px; line-height:1.6;">
          ボタンを押すとLINEが起動します。<br>
          メッセージは自動で入力されていますので、<br>そのまま送信してください。
        </p>
      </form>

    </section>
  </main>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  // 昼夜モード判定
  function isNightNow() { return (new Date().getHours() >= 18 || new Date().getHours() < 6); }
  function applyDayNight() { 
    if(isNightNow()) document.body.setAttribute("data-mode", "bar");
    else document.body.removeAttribute("data-mode");
  }
  applyDayNight(); 
  setInterval(applyDayNight, 60000);

  const lineBox = document.getElementById("lineBox");
  const step1 = document.getElementById("step1");
  const btnConnect = document.getElementById("btnConnectLine");
  const form = document.getElementById("formRegister");
  const agreeCheck = document.getElementById("agreeCheck");
  const btnApply = document.getElementById("btnApply");

  let lineUserId = null;
  let displayName = "";

  const cleanUrl = location.origin + location.pathname;
  const OA_ID = "@820theos"; 

  function showFormMode(name){
    step1.style.display = "none";
    form.style.display = "block";
    
    lineBox.innerHTML = `連絡先を確認しました。<br>ようこそ、<b>${name || "ゲスト"}</b> 様`;
    // メモ書き風にスタイル変更
    lineBox.style.background = "rgba(255,255,255,0.8)";
    lineBox.style.border = "1px solid #8d6e63";
    lineBox.style.fontFamily = "'Zen Kurenaido', sans-serif";
  }

  function makeTalkUrl(name, age, phone){
    const text = 
`【入店申請】
お名前：${name}
年齢：${age}
電話番号：${phone}

扉をノックしました。案内をお願いします。`;
    return `https://line.me/R/oaMessage/${OA_ID}/?${encodeURIComponent(text)}`;
  }

  try{
    if(typeof initLIFF === "function"){
      const r = await initLIFF();
      if(r.ok && window.liff && liff.isLoggedIn()){
        const p = await getLineProfileSafe();
        lineUserId = p.userId;
        displayName = p.displayName || "";
        showFormMode(displayName);
      }
    }
  }catch(e){ console.warn(e); }

  btnConnect.addEventListener("click", async ()=>{
    if(typeof initLIFF !== "function"){ alert("エラー：設定ファイルを読み込めませんでした。"); return; }
    try {
      const r = await initLIFF();
      if(!r.ok){ alert("LINE連携エラー: " + (r.msg || "不明")); return; }
      if(!liff.isLoggedIn()){ liff.login({ redirectUri: cleanUrl }); return; }
      const p = await getLineProfileSafe();
      lineUserId = p.userId;
      displayName = p.displayName || "";
      showFormMode(displayName);
    } catch(err) {
      console.error(err);
      alert("エラーが発生しました。");
    }
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!lineUserId){ alert("連絡先の確認（LINE連携）ができていません。"); return; }
    if(!agreeCheck.checked){ alert("規約への同意が必要です。チェックを入れてください。"); return; }

    const name  = document.getElementById("name").value.trim();
    const age   = document.getElementById("age").value.trim();
    const phone = document.getElementById("phone").value.trim();
    if(!name || !age || !phone) return alert("すべての項目を記入してください");

    const talkUrl = makeTalkUrl(name, age, phone);
    const win = window.open(talkUrl, "_blank");

    btnApply.disabled = true;
    btnApply.textContent = "呼び出し中...";
    lineBox.textContent = "LINEが開きます。そのまま送信してください。";

    try{
      if(typeof gasApply === "function"){
        const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), 8000));
        await Promise.race([ gasApply({ lineUserId, displayName, name, age, phone }), timeout ]);
      }
    }catch(err){ console.warn(err); }
    
    btnApply.textContent = "ノックしました";
    if(!win){ lineBox.innerHTML = `LINEが開かない場合は <a href="${talkUrl}" target="_blank" style="text-decoration:underline">こちら</a> をタップしてください。`; }
  });
});
</script>
</body>
</html>