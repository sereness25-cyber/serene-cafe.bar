<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LINEで新規登録｜セレネス</title>

<style>
:root{
  --bg:#fbf6f1; --card:#fff; --text:#3b352e; --muted:#7a6f63;
  --acc:#06c755; --shadow:0 14px 28px rgba(0,0,0,.08); --radius:28px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;
  background:var(--bg); color:var(--text)
}
.wrap{max-width:520px;margin:auto;padding:24px}
.card{
  background:var(--card);
  padding:28px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  text-align:center;
}
h1{margin:0 0 12px;font-size:20px}
p{margin:0;color:var(--muted);line-height:1.9}

.line-btn{
  margin-top:28px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  width:100%;
  padding:16px;
  border-radius:999px;
  border:none;
  background:var(--acc);
  color:#fff;
  font-size:16px;
  font-weight:800;
  cursor:pointer;
}
.line-btn img{width:24px;height:24px}

.note{
  margin-top:18px;
  font-size:12px;
  color:var(--muted);
  line-height:1.8;
}

.err{
  margin-top:14px;
  padding:10px 12px;
  border-radius:12px;
  background:#fff3f3;
  border:1px solid #ffd1d1;
  color:#9b1c1c;
  font-size:13px;
  display:none;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>LINEで新規登録</h1>
    <p>
      面倒な入力は不要です。<br>
      LINEアカウントを使って、<br>
      すぐに登録できます。
    </p>

    <button class="line-btn" id="lineBtn">
      <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg">
      LINEで登録する
    </button>

    <div class="err" id="err"></div>

    <div class="note">
      ※ LINEの表示名・電話番号を使用します<br>
      ※ あとから設定変更できます
    </div>
  </div>
</div>

<script>
/* =========================
 * 設定
 * ========================= */
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";

/* =========================
 * 仮LINEログイン（確認用）
 * ※ 本番では LIFF に置き換える
 * ========================= */
function mockLineLogin(){
  return {
    line_user_id: "U_TEST_001",
    name: "LINEユーザー",
    phone: "09012345678"
  };
}

const errBox = document.getElementById("err");
function showErr(msg){
  errBox.style.display="block";
  errBox.textContent=msg;
}

/* =========================
 * LINE登録処理
 * ========================= */
document.getElementById("lineBtn").addEventListener("click", async ()=>{
  errBox.style.display="none";

  // file:// 判定（超重要）
  if(location.protocol === "file:"){
    showErr("このページは file:// では動作しません。Live Server または Web公開してください。");
    return;
  }

  try{
    const line = mockLineLogin();

    // ① 新規登録
    let res = await fetch(
      `${SCRIPT_URL}?action=register_line` +
      `&line_user_id=${encodeURIComponent(line.line_user_id)}` +
      `&name=${encodeURIComponent(line.name)}` +
      `&phone=${encodeURIComponent(line.phone)}` +
      `&_=${Date.now()}`,
      { cache:"no-store" }
    );

    let data = await res.json();

    // ② 既存ならログインに切替
    if(!data.ok && data.error === "LINE_ALREADY_REGISTERED"){
      res = await fetch(
        `${SCRIPT_URL}?action=login_line` +
        `&line_user_id=${encodeURIComponent(line.line_user_id)}` +
        `&_=${Date.now()}`,
        { cache:"no-store" }
      );
      data = await res.json();
    }

    if(data.ok){
      localStorage.setItem("member_ok","1");
      localStorage.setItem("member_id", data.member_id);
      location.href = "member.html";
      return;
    }

    showErr("登録・ログインに失敗しました：" + (data.error || "不明なエラー"));

  }catch(e){
    showErr("通信エラーが発生しました。");
  }
});
</script>
</body>
</html>