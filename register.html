<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LINEで新規登録｜セレネス</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{
  --bg:#fbf6f1; --card:#fff; --text:#3b352e; --muted:#7a6f63;
  --acc:#06c755; --shadow:0 14px 28px rgba(0,0,0,.08); --radius:28px;
  --line:#e9dfd6;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:560px;margin:auto;padding:24px}
.card{background:var(--card);padding:28px;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;border:1px solid var(--line)}
h1{margin:0 0 8px;font-size:20px}
p{margin:0;color:var(--muted);line-height:1.9}

.form{margin-top:14px;text-align:left}
label{display:block;margin:10px 0 6px;font-size:12px;color:var(--muted)}
input{
  width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);font-size:15px;
}

.line-btn{
  margin-top:18px;width:100%;padding:16px;border-radius:999px;border:none;
  background:var(--acc);color:#fff;font-size:16px;font-weight:900;cursor:pointer;
}
.line-btn[disabled]{opacity:.6;cursor:not-allowed}

.err{
  margin-top:12px;padding:10px 12px;border-radius:12px;
  background:#fff3f3;border:1px solid #ffd1d1;color:#9b1c1c;
  font-size:13px;display:none;line-height:1.8;white-space:pre-wrap;text-align:left;
}
.note{margin-top:16px;font-size:12px;color:var(--muted);line-height:1.8}
.note a{color:#2563eb;text-decoration:underline}
.smallbtn{
  display:inline-block;margin-top:10px;padding:10px 12px;border-radius:12px;
  border:1px solid var(--line);text-decoration:none;color:var(--text);
  font-weight:800;background:#fff;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>LINEで新規登録</h1>
    <p>名前・年齢・電話番号を入力して、LINE連携で登録します。</p>

    <div class="form">
      <label>お名前（ニックネーム可）</label>
      <input id="name" placeholder="例）けい">

      <label>年齢</label>
      <input id="age" inputmode="numeric" placeholder="例）41">

      <label>電話番号（ハイフンなし推奨）</label>
      <input id="phone" inputmode="numeric" placeholder="例）09012345678">
    </div>

    <button class="line-btn" id="registerBtn">LINEで新規登録</button>

    <div class="err" id="err"></div>

    <div class="note">
      すでに登録済みの方は<br>
      <a href="https://liff.line.me/2006846780-ojjmzQx9?mode=login">LINEでログイン</a>
    </div>

    <div class="note" id="outsideNote" style="display:none;">
      <b>※この画面はLINEアプリ内で開く必要があります。</b><br>
      スマホで下のリンクを開いてください。<br>
      <a class="smallbtn" href="https://liff.line.me/2006846780-ojjmzQx9?mode=register">
        LINEで新規登録を開く
      </a>
    </div>
  </div>
</div>

<script>
/* ===== 共通設定 ===== */
const LIFF_ID = "2006846780-ojjmzQx9";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";
const LIFF_REGISTER_URL = `https://liff.line.me/${LIFF_ID}?mode=register`;

const errBox = document.getElementById("err");
const outsideNote = document.getElementById("outsideNote");
const btn = document.getElementById("registerBtn");

const $ = id => document.getElementById(id);
const norm = v => String(v||"").replace(/[^\d]/g,"");

function showErr(m){ errBox.style.display="block"; errBox.textContent=m; }
function hideErr(){ errBox.style.display="none"; errBox.textContent=""; }

/* ===== 入口強制（register.html直開き対策） ===== */
(function forceEntry(){
  const params = new URLSearchParams(location.search);
  if(params.get("from")==="liff") return;

  const isMobile = /iPhone|Android|iPad|iPod/i.test(navigator.userAgent);
  if(isMobile){
    location.replace(LIFF_REGISTER_URL + "&from=liff");
  }else{
    outsideNote.style.display="block";
  }
})();

/* ===== LIFF初期化 ===== */
let liffReady=false;

(async ()=>{
  try{
    await liff.init({ liffId: LIFF_ID });
    liffReady=true;

    // PCブラウザ等（LINE外）なら注意を出す（ただしLIFFは外でも動くことがある）
    if(!liff.isInClient()){
      outsideNote.style.display="block";
    }

    // ✅ ここが追加：LIFFで開けていて未ログインなら先にログインさせる
    // （クリック時にもあるけど、起動時にもやると“未連携すり抜け”が減る）
    if(liff.isInClient() && !liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

  }catch(e){
    outsideNote.style.display="block";
  }
})();();

/* ===== 新規登録 ===== */
btn.addEventListener("click", async ()=>{
  hideErr();

  const name = $("name").value.trim();
  const age  = norm($("age").value);
  const phone= norm($("phone").value);

  if(!name) return showErr("お名前を入力してください。");
  if(!age || age<18 || age>99) return showErr("年齢を正しく入力してください（18〜99）。");
  if(phone.length<10) return showErr("電話番号を正しく入力してください。");

  if(!liffReady){
    showErr("LINEアプリ内で開いてください。");
    outsideNote.style.display="block";
    return;
  }

  try{
    btn.disabled=true;

    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

    const profile = await liff.getProfile();
    const url =
      `${SCRIPT_URL}?action=register_line` +
      `&line_user_id=${encodeURIComponent(profile.userId)}` +
      `&name=${encodeURIComponent(name)}` +
      `&age=${encodeURIComponent(age)}` +
      `&phone=${encodeURIComponent(phone)}` +
      `&_=${Date.now()}`;

    const res = await fetch(url);
    const data = await res.json();

    if(data.ok){
      localStorage.setItem("member_ok","1");
      localStorage.setItem("member_id",data.member_id);
      location.href="member.html";
      return;
    }

    if(data.error==="LINE_ALREADY_REGISTERED"){
      showErr("このLINEは既に登録されています。ログインしてください。");
      setTimeout(()=>location.href="login.html",600);
      return;
    }

    showErr("登録に失敗しました。\n"+(data.error||"unknown"));
    btn.disabled=false;

  }catch(e){
    showErr("通信エラーが発生しました。");
    btn.disabled=false;
  }
});
</script>
</body>
</html>