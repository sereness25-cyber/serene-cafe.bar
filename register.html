<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LINEで新規登録｜セレネス</title>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{
  --bg:#fbf6f1; --card:#fff; --text:#3b352e; --muted:#7a6f63;
  --acc:#06c755; --shadow:0 14px 28px rgba(0,0,0,.08); --radius:28px;
  --line:#e9dfd6;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:560px;margin:auto;padding:24px}
.card{background:var(--card);padding:28px;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;border:1px solid var(--line)}
h1{margin:0 0 8px;font-size:20px}
p{margin:0;color:var(--muted);line-height:1.9}

.form{margin-top:14px;text-align:left}
label{display:block;margin:10px 0 6px;font-size:12px;color:var(--muted)}
input{
  width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);font-size:15px;
  outline:none;
}
input:focus{border-color:#c7b7a8}

.line-btn{
  margin-top:18px;
  width:100%;
  padding:16px;
  border-radius:999px;
  border:none;
  background:var(--acc);
  color:#fff;
  font-size:16px;
  font-weight:900;
  cursor:pointer;
}
.line-btn[disabled]{opacity:.6;cursor:not-allowed}

.err{
  margin-top:12px;
  padding:10px 12px;
  border-radius:12px;
  background:#fff3f3;
  border:1px solid #ffd1d1;
  color:#9b1c1c;
  font-size:13px;
  display:none;
  line-height:1.8;
  text-align:left;
  white-space:pre-wrap;
}
.note{margin-top:16px;font-size:12px;color:var(--muted);line-height:1.8}
.note a{color:#2563eb;text-decoration:underline}
.smallbtn{
  display:inline-block;margin-top:10px;
  padding:10px 12px;border-radius:12px;border:1px solid var(--line);
  text-decoration:none;color:var(--text);font-weight:800;background:#fff;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>LINEで新規登録</h1>
    <p>名前・年齢・電話番号を入力して、LINE連携で登録します。</p>

    <div class="form">
      <label>お名前（ニックネーム可）</label>
      <input id="name" placeholder="例）けい">

      <label>年齢</label>
      <input id="age" inputmode="numeric" placeholder="例）41">

      <label>電話番号（ハイフンなし推奨）</label>
      <input id="phone" inputmode="numeric" placeholder="例）09012345678">
    </div>

    <button class="line-btn" id="registerBtn">LINEで新規登録</button>

    <div class="err" id="err"></div>

    <div class="note">
      すでに登録済みの方は<br>
      <a href="https://liff.line.me/2006846780-ojjmzQx9?mode=login">LINEでログイン</a>
    </div>

    <div class="note" id="outsideNote" style="display:none;">
      <b>※この画面はLINEアプリ内で開く必要があります。</b><br>
      スマホで下のリンクを開くか、QR化して読み取ってください。<br>
      <a class="smallbtn" href="https://liff.line.me/2006846780-ojjmzQx9?mode=register">LINEで新規登録を開く</a>
    </div>
  </div>
</div>

<script>
/* ===== 設定 ===== */
const LIFF_ID = "2006846780-ojjmzQx9";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";
const LIFF_REGISTER_URL = "https://liff.line.me/2006846780-ojjmzQx9?mode=register";

const errBox = document.getElementById("err");
const outsideNote = document.getElementById("outsideNote");
const btn = document.getElementById("registerBtn");

function showErr(msg){
  errBox.style.display="block";
  errBox.textContent=msg;
}
function hideErr(){
  errBox.style.display="none";
  errBox.textContent="";
}
function normDigits(v){ return String(v||"").replace(/[^\d]/g,""); }

/* --- JSON以外を返された時に原因を潰さない --- */
async function fetchJson(url){
  const res = await fetch(url, { method:"GET", cache:"no-store" });
  const ct = (res.headers.get("content-type") || "").toLowerCase();
  const text = await res.text();

  if(!ct.includes("application/json")){
    throw new Error("NOT_JSON_RESPONSE\n" + text.slice(0, 800));
  }
  try{ return JSON.parse(text); }
  catch(e){ throw new Error("JSON_PARSE_FAILED\n" + text.slice(0, 800)); }
}

/* ===== 入口の統一（超重要） =====
   GitHubのregister.htmlを直接開かれたら、
   1回だけLIFFのURLへ誘導して「正しい入口」に戻す
*/
(function forceLiffEntry(){
  const u = new URL(location.href);
  const from = u.searchParams.get("from");

  // すでにLIFFから来てる or 既に誘導済みなら何もしない
  if(from === "liff") return;

  // PCで直接開かれた場合は、勝手に飛ばすと迷子になるので表示で案内
  // ただし、スマホのブラウザで開かれた場合はLIFFへ送ってOK
  const isProbablyMobile = /iPhone|Android|iPad|iPod/i.test(navigator.userAgent);
  if(isProbablyMobile){
    location.replace(LIFF_REGISTER_URL + "&from=liff");
    return;
  }
  // PCは案内だけ出す
  outsideNote.style.display = "block";
})();

/* ===== LIFF 初期化 ===== */
let liffReady = false;
(async function initLIFF(){
  try{
    await liff.init({ liffId: LIFF_ID });
    liffReady = true;

    // LINEアプリ内じゃないなら案内表示（PCはここに落ちることが多い）
    if(!liff.isInClient()){
      outsideNote.style.display = "block";
    }

  }catch(e){
    // LIFF初期化すらできない = まず入口が違う
    outsideNote.style.display = "block";
  }
})();

/* ===== 新規登録 ===== */
btn.addEventListener("click", async ()=>{
  hideErr();

  const name = (document.getElementById("name").value || "").trim();
  const age  = normDigits(document.getElementById("age").value);
  const phone= normDigits(document.getElementById("phone").value);

  if(!name){ showErr("お名前を入力してください。"); return; }
  if(!age || Number(age) < 18 || Number(age) > 99){ showErr("年齢を正しく入力してください（18〜99）。"); return; }
  if(phone.length < 10){ showErr("電話番号を正しく入力してください。"); return; }

  if(!liffReady){
    showErr("このページはLINEアプリ内（LIFF）で開いてください。\n" + LIFF_REGISTER_URL);
    outsideNote.style.display = "block";
    return;
  }

  try{
    btn.disabled = true;

    // ボタン押下時のみログイン
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

    // userId取得（LINEアプリ内前提）
    const profile = await liff.getProfile();
    const lineUserId = profile.userId;

    const url =
      `${SCRIPT_URL}?action=register_line` +
      `&line_user_id=${encodeURIComponent(lineUserId)}` +
      `&name=${encodeURIComponent(name)}` +
      `&age=${encodeURIComponent(age)}` +
      `&phone=${encodeURIComponent(phone)}` +
      `&_=${Date.now()}`;

    const data = await fetchJson(url);

    if(data.ok){
      localStorage.setItem("member_ok","1");
      localStorage.setItem("member_id", data.member_id);
      location.href = "member.html";
      return;
    }

    // 想定エラー
    if(data.error === "LINE_ALREADY_REGISTERED"){
      showErr("このLINEは既に登録されています。ログインしてください。");
      setTimeout(()=> location.href="login.html", 500);
      return;
    }
    if(data.error === "PHONE_TAKEN"){
      showErr("この電話番号は既に使用されています。別の番号でお試しください。");
      btn.disabled = false;
      return;
    }

    showErr("登録に失敗しました。\n" + (data.error || "unknown"));
    btn.disabled = false;

  }catch(e){
    // 原因が見えるように出す
    showErr("通信エラー/設定エラーです。\n\n" + String(e && e.message ? e.message : e));
    btn.disabled = false;
  }
});
</script>
</body>
</html>