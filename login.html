<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LINEでログイン｜セレネス</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{
  --bg:#fbf6f1; --card:#fff; --text:#3b352e; --muted:#7a6f63;
  --acc:#06c755; --shadow:0 14px 28px rgba(0,0,0,.08); --radius:28px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;
  background:var(--bg); color:var(--text)
}
.wrap{max-width:520px;margin:auto;padding:24px}
.card{
  background:var(--card);
  padding:28px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  text-align:center;
}
h1{margin:0 0 12px;font-size:20px}
p{margin:0;color:var(--muted);line-height:1.9}
.line-btn{
  margin-top:28px;
  width:100%;
  padding:16px;
  border-radius:999px;
  border:none;
  background:var(--acc);
  color:#fff;
  font-size:16px;
  font-weight:800;
  cursor:pointer;
}
.line-btn[disabled]{opacity:.6;cursor:not-allowed}
.err{
  margin-top:14px;
  color:#b91c1c;
  font-size:13px;
  display:none;
  line-height:1.8;
}
.note{
  margin-top:18px;
  font-size:12px;
  color:var(--muted);
  line-height:1.8;
}
.note a{color:#2563eb;text-decoration:underline}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>LINEでログイン</h1>
    <p>登録済みのLINEアカウントで<br>ログインします</p>

    <button class="line-btn" id="lineBtn" disabled>LINEでログイン</button>
    <div class="err" id="err"></div>

    <div class="note">
      ※ まだ登録していない方は<br>
      <a id="registerLink" href="#">LINEで新規登録</a>
    </div>
  </div>
</div>

<script>
/* ===== 設定 ===== */
const LIFF_ID = "2006846780-ojjmzQx9";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";

const errBox = document.getElementById("err");
const lineBtn = document.getElementById("lineBtn");
const registerLink = document.getElementById("registerLink");

function showErr(msg){
  errBox.style.display = "block";
  errBox.textContent = msg;
}
function hideErr(){
  errBox.style.display = "none";
  errBox.textContent = "";
}

/* ===== LIFF入口（統一してmodeで分岐） ===== */
const LIFF_LOGIN_URL    = `https://liff.line.me/${LIFF_ID}?mode=login`;
const LIFF_REGISTER_URL = `https://liff.line.me/${LIFF_ID}?mode=register`;
registerLink.href = LIFF_REGISTER_URL;

/* ===== mode判定：registerならregister.htmlへ ===== */
function routeByMode(){
  const params = new URLSearchParams(location.search);
  const mode = (params.get("mode") || "").toLowerCase();

  // 以前の /register 形式が紛れ込んでも拾う（保険）
  const state = params.get("liff.state") || "";
  if(mode === "register" || state.startsWith("/register")){
    location.replace("register.html");
    return true; // ルーティングした
  }
  return false;
}

/* ===== LIFF初期化（ページを開いただけではloginしない） ===== */
async function initLIFF(){
  try{
    await liff.init({ liffId: LIFF_ID });

    // mode=register の場合はここで register.html に送る
    if(routeByMode()) return;

    // ここまで来たらログイン画面として使う
    lineBtn.disabled = false;

  }catch(e){
    showErr("このページはLINEアプリ内で開いてください。");
  }
}
initLIFF();

/* ===== ログイン処理（ボタン押下時のみ） ===== */
lineBtn.addEventListener("click", async ()=>{
  hideErr();

  try{
    lineBtn.disabled = true;

    // ボタンを押した時だけLINEログイン
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: LIFF_LOGIN_URL });
      return;
    }

    const profile = await liff.getProfile();
    const url =
      `${SCRIPT_URL}?action=login_line` +
      `&line_user_id=${encodeURIComponent(profile.userId)}` +
      `&_=${Date.now()}`;

    const res = await fetch(url, { method:"GET", cache:"no-store" });
    const data = await res.json();

    if(data.ok){
      localStorage.setItem("member_ok","1");
      localStorage.setItem("member_id", data.member_id);
      location.href = "member.html";
      return;
    }

    showErr("未登録のLINEアカウントです。新規登録してください。");
    lineBtn.disabled = false;

  }catch(e){
    showErr("通信エラーが発生しました。");
    lineBtn.disabled = false;
  }
});
</script>
</body>
</html>