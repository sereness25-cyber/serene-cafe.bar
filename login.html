<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>セレネス｜LINEログイン</title>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{
  --bg:#fbf6f1; --card:#fff; --text:#3b352e; --muted:#7a6f63;
  --acc:#06c755; --pri:#4f7cff;
  --shadow:0 14px 28px rgba(0,0,0,.08); --radius:28px;
  --line:#e9dfd6;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:560px;margin:auto;padding:24px}
.card{
  background:var(--card);
  padding:28px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid var(--line);
  text-align:center;
}
h1{margin:0 0 8px;font-size:20px}
p{margin:0;color:var(--muted);line-height:1.9}

.btn{
  margin-top:18px;width:100%;
  padding:16px;border-radius:999px;border:none;
  background:var(--acc);color:#fff;font-size:16px;font-weight:900;
  cursor:pointer;
}
.btn.blue{background:var(--pri)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

.err{
  margin-top:12px;padding:10px 12px;border-radius:12px;
  background:#fff3f3;border:1px solid #ffd1d1;color:#9b1c1c;
  font-size:13px;display:none;line-height:1.8;white-space:pre-wrap;text-align:left;
}
.note{margin-top:16px;font-size:12px;color:var(--muted);line-height:1.8}
.note a{color:#2563eb;text-decoration:underline}
.smallbtn{
  display:inline-block;margin-top:10px;padding:10px 12px;border-radius:12px;
  border:1px solid var(--line);text-decoration:none;color:var(--text);
  font-weight:800;background:#fff;
}
.hr{border:0;border-top:1px solid var(--line);margin:18px 0}
.badge{
  display:inline-flex;gap:8px;align-items:center;
  font-size:12px;font-weight:900;color:var(--text);
  border:1px solid var(--line);background:#fff;
  padding:6px 10px;border-radius:999px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="badge" id="modeBadge">LINEログイン</div>
    <h1 id="title">LINEでログイン</h1>
    <p id="desc">LINE連携でログインします。</p>

    <button class="btn" id="loginBtn">LINEでログイン</button>

    <div class="err" id="err"></div>

    <div class="note" id="switchArea">
      初めての方は<br>
      <a id="toRegister" href="#">LINEで新規登録</a>
    </div>

    <div class="note" id="outsideNote" style="display:none;">
      <b>※この画面はLINEアプリ内（LIFF）で開く必要があります。</b><br>
      下のリンクをスマホで開いてください。<br>
      <a class="smallbtn" id="openInLiff" href="#">LINEで開く</a>
    </div>

    <div class="hr"></div>

    <div class="note">
      うまくいかない場合：<br>
      ・LINEアプリで開いているか確認<br>
      ・通信環境を確認<br>
      ・もう一度ボタンを押す
    </div>
  </div>
</div>

<script>
/* ======================
   設定
====================== */
const LIFF_ID = "2006846780-ojjmzQx9";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";

// ユーザー指定どおりの LIFF URL（必ずこれを使う）
const LIFF_REGISTER_URL = "https://liff.line.me/2006846780-ojjmzQx9?mode=register";
const LIFF_LOGIN_URL    = "https://liff.line.me/2006846780-ojjmzQx9?mode=login";

/* ======================
   DOM / 便利関数
====================== */
const $ = id => document.getElementById(id);
const errBox = $("err");
const outsideNote = $("outsideNote");
const openInLiff = $("openInLiff");
const loginBtn = $("loginBtn");

function showErr(m){ errBox.style.display="block"; errBox.textContent=m; }
function hideErr(){ errBox.style.display="none"; errBox.textContent=""; }

/* ======================
   直開き対策（ここ重要）
   - login.html をブラウザ直開き → LIFF URL を案内
   - 自動リダイレクトは環境でループ/ブロック起きるので「案内」方式
====================== */
openInLiff.href = LIFF_LOGIN_URL;
$("toRegister").href = LIFF_REGISTER_URL;

/* ======================
   LIFF 初期化
====================== */
let liffReady = false;

(async ()=>{
  try{
    await liff.init({ liffId: LIFF_ID });
    liffReady = true;

    // LINEアプリ内でなければ案内表示
    if(!liff.isInClient()){
      outsideNote.style.display = "block";
    }
  }catch(e){
    outsideNote.style.display = "block";
    showErr("LIFFの初期化に失敗しました。\nLINEアプリ内で開いてください。");
  }
})();

/* ======================
   ログイン処理
====================== */
loginBtn.addEventListener("click", async ()=>{
  hideErr();

  // 1) LIFF準備
  if(!liffReady){
    outsideNote.style.display = "block";
    return showErr("LINEアプリ内（LIFF）で開いてください。");
  }

  // 2) LINEログイン（未ログインならここでLINEのログイン画面へ）
  //    redirectUri は「この login.html 自身（mode=login付き）」に戻す
  if(!liff.isLoggedIn()){
    liff.login({ redirectUri: location.origin + location.pathname + "?mode=login" });
    return;
  }

  try{
    loginBtn.disabled = true;

    // 3) userId取得
    const profile = await liff.getProfile();
    const userId = profile.userId;

    // 4) GASへ照合
    const url =
      `${SCRIPT_URL}?action=login_line` +
      `&line_user_id=${encodeURIComponent(userId)}` +
      `&_=${Date.now()}`;

    const res = await fetch(url, { method:"GET", cache:"no-store" });
    const data = await res.json();

    // 5) 成功 → member.html（ここだけ）
    if(data && data.ok){
      localStorage.setItem("member_ok", "1");
      localStorage.setItem("member_id", data.member_id || "");
      if(data.name) localStorage.setItem("member_name", data.name);

      location.href = "member.html";
      return;
    }

    // 6) エラー分岐
    const err = (data && data.error) ? String(data.error) : "unknown";

    if(err === "NOT_REGISTERED"){
      showErr("このLINEはまだ登録されていません。\n新規登録をお願いします。");
      // LIFFのregisterへ（indexには戻さない）
      setTimeout(()=> location.href = LIFF_REGISTER_URL, 700);
      return;
    }

    if(err === "INACTIVE"){
      showErr("このアカウントは現在利用できません。\n運営にお問い合わせください。");
      loginBtn.disabled = false;
      return;
    }

    showErr("ログインに失敗しました。\n" + err);
    loginBtn.disabled = false;

  }catch(e){
    showErr("通信エラーが発生しました。");
    loginBtn.disabled = false;
  }
});
</script>
</body>
</html>