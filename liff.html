<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Router</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<script>
/* ======================
   設定
====================== */
const LIFF_ID = "2006846780-ojjmzQx9";

// 行き先（あなたの構成に合わせて）
const DEST_REGISTER = "register.html"; // 新規登録ページ
const DEST_LOGIN    = "login.html";    // ログインページ

/* ======================
   mode復元関数
   - 1) まずは普通に ?mode= を見る
   - 2) 無ければ liff.state の中を見る（ログイン後によくここに入る）
====================== */
function getMode(){
  const p = new URLSearchParams(location.search);

  // ① 直で mode がある
  const direct = p.get("mode");
  if(direct) return direct;

  // ② liff.state の中に元のクエリが退避されることがある
  // 例: ?liff.state=mode%3Dregister
  const st = p.get("liff.state");
  if(st){
    try{
      const decoded = decodeURIComponent(st);
      const sp = new URLSearchParams(decoded.startsWith("?") ? decoded.slice(1) : decoded);
      const m = sp.get("mode");
      if(m) return m;
    }catch(e){}
  }

  // ③ それでも無ければ login 扱い
  return "login";
}

(async ()=>{
  const mode = (getMode() || "login").toLowerCase();

  try{
    await liff.init({ liffId: LIFF_ID });

    // 未ログインなら、ログインして同じURL（=mode付き）に戻す
    // ※ location.href を使うことで mode が保持されやすい
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

    // ここまで来たら mode に従って振り分け
    if(mode === "register"){
      location.replace(DEST_REGISTER);
      return;
    }else{
      location.replace(DEST_LOGIN);
      return;
    }

  }catch(e){
    // LIFF初期化失敗時は、保険で通常ページへ
    if(mode === "register"){
      location.replace(DEST_REGISTER);
    }else{
      location.replace(DEST_LOGIN);
    }
  }
})();
</script>
</body>
</html>