<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Router</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<script>
/* ======================
   設定
====================== */
const LIFF_ID = "2006846780-ojjmzQx9";

// 送る先（この2ページが「フロントの実ページ」）
const DEST_REGISTER = "register.html";
const DEST_LOGIN    = "login.html";

// ルーターが同一セッションで何度も走ってループしない保険
const ROUTED_KEY = "liff_router_routed";

/* ======================
   mode復元
   1) ?mode= を見る
   2) 無ければ ?liff.state= の中を見る（LINEログイン後にここへ入ることが多い）
====================== */
function getMode(){
  const p = new URLSearchParams(location.search);

  // ① URL直の mode
  const direct = p.get("mode");
  if (direct) return direct;

  // ② liff.state に退避されるケース
  // 例: ?liff.state=mode%3Dregister
  const st = p.get("liff.state");
  if (st) {
    try {
      const decoded = decodeURIComponent(st);
      const sp = new URLSearchParams(decoded.startsWith("?") ? decoded.slice(1) : decoded);
      const m = sp.get("mode");
      if (m) return m;
    } catch (e) {}
  }

  return "login";
}

/* ======================
   redirectUri（modeを絶対に保持する）
   - liff.state が付いてても、mode は getMode() で復元できる
   - ただし最も確実なのは「元のmodeを明示して戻す」こと
====================== */
function buildRedirectUri(mode){
  const url = new URL(location.href);

  // liff.state が付いてたら消しておく（連鎖で複雑になるのを防ぐ）
  url.searchParams.delete("liff.state");

  // mode を必ず明示
  url.searchParams.set("mode", mode);

  // ルーター保険（初回だけ login させる）
  url.searchParams.set("router", "1");

  return url.toString();
}

/* ======================
   最終遷移URLを作る（modeを必ず渡す）
====================== */
function buildDestUrl(destPath, mode){
  const u = new URL(destPath, location.href);
  u.searchParams.set("mode", mode);
  u.searchParams.set("from", "liff");   // register側の直開き対策に使える
  u.searchParams.set("_", Date.now());  // キャッシュ対策（任意）
  return u.toString();
}

(async ()=>{
  const modeRaw = getMode();
  const mode = String(modeRaw || "login").trim().toLowerCase() === "register" ? "register" : "login";

  try{
    await liff.init({ liffId: LIFF_ID });

    // 未ログインなら、ログインして「mode付きの同じ場所」に必ず戻す
    // ※ここがズレると register が login に落ちる原因になる
    if(!liff.isLoggedIn()){
      // すでに一度 login を叩いたのに戻ってきて未ログインなら、ループ回避
      if (sessionStorage.getItem(ROUTED_KEY) === "1") {
        // LINEアプリ外などの可能性 → 保険で通常ページへ
        location.replace(buildDestUrl(mode === "register" ? DEST_REGISTER : DEST_LOGIN, mode));
        return;
      }
      sessionStorage.setItem(ROUTED_KEY, "1");
      liff.login({ redirectUri: buildRedirectUri(mode) });
      return;
    }

    // ログインできている → mode通りに分岐（modeを付けて渡す）
    sessionStorage.removeItem(ROUTED_KEY);

    if(mode === "register"){
      location.replace(buildDestUrl(DEST_REGISTER, "register"));
    }else{
      location.replace(buildDestUrl(DEST_LOGIN, "login"));
    }
    return;

  }catch(e){
    // LIFF初期化失敗 → 保険で通常ページへ（modeは維持）
    if(mode === "register"){
      location.replace(buildDestUrl(DEST_REGISTER, "register"));
    }else{
      location.replace(buildDestUrl(DEST_LOGIN, "login"));
    }
  }
})();
</script>
</body>
</html>