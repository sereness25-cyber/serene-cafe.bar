<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Router (Debug)</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",system-ui,sans-serif;padding:16px}
    pre{background:#f6f7fb;border:1px solid #e5e7eb;padding:12px;border-radius:12px;white-space:pre-wrap;word-break:break-all}
  </style>
</head>
<body>
<h2>LIFF Router Debug</h2>
<pre id="log">loading...</pre>

<script>
const LIFF_ID = "2006846780-ojjmzQx9";
const DEST_REGISTER = "register.html";
const DEST_LOGIN    = "login.html";
const MODE_KEY = "serene_mode";

const log = (m)=>{ document.getElementById("log").textContent += m + "\n"; };

function normalizeMode(m){
  m = String(m||"").trim().toLowerCase();
  return (m==="register") ? "register" : "login";
}

function parseModeFromQS(qs){
  if(!qs) return null;
  const p = new URLSearchParams(qs.startsWith("?") ? qs.slice(1) : qs);
  const m = p.get("mode");
  return m ? normalizeMode(m) : null;
}

function getMode(){
  const p = new URLSearchParams(location.search);

  const direct = p.get("mode");
  if(direct){
    const m = normalizeMode(direct);
    sessionStorage.setItem(MODE_KEY, m);
    return {mode:m, from:"direct(mode=)"};
  }

  const st = p.get("liff.state");
  if(st){
    try{
      const decoded = decodeURIComponent(st);
      let m = parseModeFromQS(decoded);
      if(!m && decoded.includes("?")) m = parseModeFromQS(decoded.split("?").pop());
      if(m){
        sessionStorage.setItem(MODE_KEY, m);
        return {mode:m, from:"liff.state"};
      }
    }catch(e){}
  }

  const last = sessionStorage.getItem(MODE_KEY);
  if(last) return {mode: normalizeMode(last), from:"sessionStorage"};

  return {mode:"login", from:"default"};
}

function go(mode){
  const m = normalizeMode(mode);
  const dest = (m==="register") ? DEST_REGISTER : DEST_LOGIN;
  location.replace(`${dest}?mode=${encodeURIComponent(m)}`);
}

(async ()=>{
  document.getElementById("log").textContent = "";
  log("location.href = " + location.href);

  const r = getMode();
  log("parsed mode = " + r.mode + " (from: " + r.from + ")");

  try{
    await liff.init({ liffId: LIFF_ID });
    log("liff.init OK");
    log("isInClient = " + liff.isInClient());
    log("isLoggedIn = " + liff.isLoggedIn());

    if(!liff.isLoggedIn()){
      log("-> liff.login()");
      liff.login({ redirectUri: location.href });
      return;
    }

    log("-> route to " + r.mode);
    go(r.mode);

  }catch(e){
    log("liff.init FAILED: " + (e && e.message ? e.message : e));
    log("-> route anyway to " + r.mode);
    go(r.mode);
  }
})();
</script>
</body>
</html>