<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒ£ãƒƒãƒˆï½œã‚»ãƒ¬ãƒã‚¹</title>

<style>
:root{
  /* Cafeï¼ˆæ˜¼ï¼‰ */
  --bg:#fbf6f1;
  --card:#ffffff;
  --line:#eadfce;
  --text:#3b352e;
  --muted:#7a6f63;

  --acc:#c9a36a;
  --shadow:0 14px 28px rgba(0,0,0,.08);
  --radius:26px;

  /* chat */
  --bubble:#ffffff;
  --bubble_me:#d9f1ff; /* æ°´è‰² */
  --bubble_border:rgba(234,223,206,.95);
  --chat_bg:rgba(255,255,255,.70);
  --chat_glow:rgba(201,163,106,.14);
}

body.night{
  --bg:#1a1714;
  --card:#221d19;
  --line:#4a3f34;
  --text:#f3eee7;
  --muted:#c8bbaf;

  --acc:#cda861;
  --shadow:0 18px 44px rgba(0,0,0,.42);

  --bubble:rgba(255,255,255,.10);
  --bubble_me:rgba(80, 170, 255, .18); /* å¤œã®æ°´è‰² */
  --bubble_border:rgba(255,255,255,.10);

  --chat_bg:rgba(0,0,0,.18);
  --chat_glow:rgba(255,210,120,.18);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 520px at 18% -10%, var(--chat_glow), transparent 62%),
    radial-gradient(700px 420px at 85% 0%, rgba(201,163,106,.10), transparent 60%),
    linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
  transition: background .35s ease, color .25s ease;
}

.wrap{max-width:900px;margin:auto;padding:22px}
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
  border:1px solid var(--line);
  position:relative;
  overflow:hidden;
}

.themeGlow{
  pointer-events:none;
  position:absolute; inset:-40px;
  background:
    radial-gradient(420px 260px at 18% 10%, rgba(255,230,170,.22), transparent 65%),
    radial-gradient(420px 260px at 82% 0%, rgba(201,163,106,.18), transparent 70%);
  opacity:0;
  transform:scale(1.02);
  transition:opacity .55s ease, transform .55s ease;
}
body.themeSwitching .themeGlow{
  opacity:1;
  transform:scale(1);
}

h1{margin:0;font-size:18px}
p{color:var(--muted);line-height:1.8;margin:8px 0 0}

.headRow{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.smallHint{
  font-size:12px;
  color:var(--muted);
  border:1px solid var(--line);
  background:rgba(255,255,255,.55);
  padding:6px 10px;
  border-radius:999px;
}
body.night .smallHint{ background:rgba(0,0,0,.18); }

.input, textarea{
  width:100%;
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  font-size:14px;
  background:transparent;
  color:var(--text);
}
textarea{min-height:72px}

.btn{
  padding:10px 14px;
  border-radius:18px;
  border:1px solid var(--line);
  background:transparent;
  font-weight:900;
  cursor:pointer;
  color:var(--text);
}
.btn.primary{
  background:linear-gradient(180deg, rgba(201,163,106,.30), rgba(201,163,106,.12));
}
.btn.danger{
  border-color:rgba(239,68,68,.35);
  background:rgba(239,68,68,.10);
  color:#7a2b2b;
}

.sep{border:none;border-top:1px solid var(--line);margin:14px 0}

.chatWrap{
  background:var(--chat_bg);
  border:1px solid var(--line);
  border-radius:22px;
  padding:14px;
  max-height:62vh;
  overflow:auto;
  scroll-behavior:smooth;
}
.chatEmpty{
  text-align:center;
  color:var(--muted);
  font-size:13px;
  padding:16px 8px;
}

.daySep{
  display:flex;justify-content:center;
  margin:10px 0;
}
.daySep span{
  font-size:11px;
  color:var(--muted);
  background:rgba(255,255,255,.55);
  border:1px solid var(--line);
  padding:6px 10px;
  border-radius:999px;
}
body.night .daySep span{ background:rgba(0,0,0,.22); }

.row{
  display:flex;
  margin:8px 0;
  gap:10px;
}
.row.other{ justify-content:flex-start; }
.row.me{ justify-content:flex-end; }

.bubble{
  max-width:78%;
  border-radius:18px;
  padding:10px 12px;
  border:1px solid var(--bubble_border);
  background:var(--bubble);
  box-shadow:0 10px 18px rgba(0,0,0,.06);
}
.row.me .bubble{
  background:var(--bubble_me);
  border-color:rgba(255,255,255,.10);
}

.replyLine{
  font-size:11px;
  color:var(--muted);
  margin-bottom:6px;
  padding-bottom:6px;
  border-bottom:1px dashed rgba(0,0,0,.08);
}
body.night .replyLine{
  border-bottom:1px dashed rgba(255,255,255,.14);
}

.nameLine{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:4px;
}
.nameBtn{
  border:none;
  background:none;
  padding:0;
  margin:0;
  font-weight:900;
  font-size:12px;
  color:var(--text);
  cursor:pointer;
  text-decoration:underline;
  text-decoration-color:rgba(201,163,106,.55);
  text-underline-offset:3px;
}
.nameBtn.disabled{
  cursor:default;
  text-decoration:none;
  opacity:.65;
}
.meta{
  font-size:10px;
  color:var(--muted);
  margin-left:auto;
  white-space:nowrap;
}
.text{
  font-size:14px;
  line-height:1.75;
  white-space:pre-wrap;
  word-break:break-word;
}
.tools{
  display:flex;
  gap:8px;
  justify-content:flex-end;
  margin-top:8px;
}
.btnMini{
  font-size:12px;
  padding:8px 10px;
  border-radius:999px;
}

/* è¿”ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
.replyPreview{
  display:none;
  margin:0 0 10px;
}
.replyChip{
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px 12px;
  background:rgba(255,255,255,.70);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
body.night .replyChip{ background:rgba(0,0,0,.15); }
.replyChip b{font-size:12px}
.replyChip span{font-size:12px;color:var(--muted);line-height:1.5}

.modalBack{
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:9999;
}
.modal{
  width:min(520px,100%);
  background:var(--card);
  border-radius:22px;
  border:1px solid var(--line);
  box-shadow:0 20px 60px rgba(0,0,0,.20);
  padding:16px;
}
.modalTop{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.modalTop b{font-size:15px}
.modalTop button{
  border:none;background:transparent;cursor:pointer;
  font-size:22px;color:var(--muted);
}
.modal p{margin:10px 0 0;color:var(--muted);font-size:12px;line-height:1.8}
.kv{
  margin-top:12px;
  display:grid;
  gap:10px;
}
.kv .item{
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px 12px;
  background:rgba(255,255,255,.70);
}
body.night .kv .item{ background:rgba(0,0,0,.15); }
.kv .item b{display:block;font-size:12px}
.kv .item span{display:block;margin-top:4px;color:var(--muted);font-size:12px;line-height:1.65}

#valueRadar{ width:100% !important; max-width:100%; }

.toast{
  position:fixed;
  bottom:18px;
  left:50%;
  transform:translateX(-50%);
  background:#3b352e;
  color:#fff;
  padding:10px 16px;
  border-radius:999px;
  font-size:13px;
  display:none;
  z-index:10000;
}
body.night .toast{ background:#111; }
</style>

<!-- â˜…ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç”¨ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="wrap">

  <div class="card">
    <div class="themeGlow" aria-hidden="true"></div>

    <div class="headRow">
      <div>
        <h1>ğŸ’¬ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒ£ãƒƒãƒˆ</h1>
        <p>
          ã¿ã‚“ãªã§æ°—è»½ã«è©±ã›ã‚‹ãƒãƒ£ãƒƒãƒˆã§ã™ã€‚é›‘è«‡ãƒ»ç›¸è«‡ãƒ»ã²ã¨ã“ã¨æ­“è¿ã€‚<br>
          â€» å…¬é–‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ONã®æ–¹ã¯ã€åå‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç°¡æ˜“ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚
        </p>
      </div>
      <div class="smallHint" id="themeHint">Cafe</div>
    </div>

    <div class="sep"></div>

    <div>
      <!-- â˜…è¿”ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒªãƒ—ãƒ©ã‚¤æ©Ÿèƒ½ï¼‰ -->
      <div class="replyPreview" id="replyPreview">
        <div class="replyChip">
          <div>
            <b>è¿”ä¿¡å…ˆ</b>
            <span id="replyName">â€”</span>
          </div>
          <button class="btn btnMini" id="cancelReply" type="button">å–æ¶ˆ</button>
        </div>
      </div>

      <textarea id="body" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦é€ä¿¡"></textarea>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap">
        <button class="btn primary" id="postBtn">é€ä¿¡</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="chatWrap" id="chat">
      <div class="chatEmpty">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
  </div>

</div>

<div class="modalBack" id="reportBack">
  <div class="modal">
    <div class="modalTop">
      <b>é€šå ±ã™ã‚‹</b>
      <button type="button" id="closeReport">Ã—</button>
    </div>
    <p>ä¸é©åˆ‡ã ã¨æ„Ÿã˜ãŸç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰ã€‚</p>
    <textarea id="reportReason" style="margin-top:10px;min-height:90px"></textarea>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap">
      <button class="btn" id="cancelReport">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn danger" id="sendReport">é€šå ±ã™ã‚‹</button>
    </div>
  </div>
</div>

<div class="modalBack" id="profileBack">
  <div class="modal">
    <div class="modalTop">
      <b id="pmTitle">ç°¡æ˜“ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</b>
      <button type="button" id="closeProfile">Ã—</button>
    </div>

    <!-- â˜…è¡¨ç¤ºï¼šãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  + ä¸€è‡´æ•°ãªã© -->
    <div class="kv" id="pmBody"></div>

    <!-- â˜…ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼ˆè‡ªåˆ† vs ç›¸æ‰‹ã®ä¸€è‡´åº¦ï¼‰ -->
    <div style="margin-top:16px">
      <canvas id="valueRadar" height="260"></canvas>
    </div>

    <!-- â˜…ã²ã¨ã“ã¨ -->
    <div class="kv" style="margin-top:14px">
      <div class="item">
        <b>ã²ã¨ã“ã¨</b>
        <span id="pmBio">â€”</span>
      </div>
    </div>

    <p id="pmNote">å…¬é–‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ONã®æ–¹ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
  </div>
</div>

<div class="toast" id="toast">OK</div>

<script>
/* =========================
   Theme
========================= */
(function autoTheme(){
  const h = new Date().getHours();
  const isNight = (h >= 18 || h < 6);
  const hint = document.getElementById("themeHint");

  if(isNight){
    document.body.classList.add("night");
    hint.textContent = "Bar";
  }else{
    hint.textContent = "Cafe";
  }

  document.body.classList.add("themeSwitching");
  setTimeout(()=> document.body.classList.remove("themeSwitching"), 700);
})();

/* =========================
   GAS
========================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";

/* =========================
   utils
========================= */
function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", 2200);
}
function fmtTime(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function fmtDay(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function getPublicIdFromItem(x){
  const cand = [x.publicProfileId, x.public_profile_id, x.publicProfileID, x.publicprofileid];
  const v = cand.find(v => String(v||"").trim());
  return String(v||"").trim();
}
function normAns(v){
  return String(v||"").trim();
}

/* =========================
   âœ… é‡è¦ï¼šè‡ªåˆ†ã®å…¬é–‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã¯ â€œGASã‹ã‚‰å–å¾—â€ ã™ã‚‹
========================= */
function getMemberId(){
  return (localStorage.getItem("member_id")
    || localStorage.getItem("memberId")
    || localStorage.getItem("user_id")
    || localStorage.getItem("userId")
    || "").trim();
}

const memberId = getMemberId();

/** è‡ªåˆ†ã®å…¬é–‹çŠ¶æ…‹ï¼‹è‡ªåˆ†ã®ä¾¡å€¤è¦³q1ã€œq12ï¼ˆæ¯”è¼ƒç”¨ï¼‰ */
let ME_PUBLIC = { enabled:false, id:"", nickname:"", alias:"", q:{} };

/** ç›¸æ‰‹ã®ç°¡æ˜“ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨ï¼‰ */
let radarChart = null;

/* =========================
   â˜…ãƒªãƒ—ãƒ©ã‚¤çŠ¶æ…‹
========================= */
let REPLY_TO = null; // { id, name }

function setReplyTo(obj){
  REPLY_TO = obj;
  if(REPLY_TO){
    document.getElementById("replyName").textContent = REPLY_TO.name || "â€”";
    document.getElementById("replyPreview").style.display = "block";
  }else{
    document.getElementById("replyPreview").style.display = "none";
    document.getElementById("replyName").textContent = "â€”";
  }
}

document.getElementById("cancelReply").onclick = ()=>{
  setReplyTo(null);
};

/* =========================
   è‡ªåˆ†ã®å…¬é–‹æƒ…å ±å–å¾—
========================= */
async function fetchMyPublic(){
  if(!memberId) return;
  try{
    const res = await fetch(`${GAS_URL}?action=get_my_values&id=${encodeURIComponent(memberId)}&_=${Date.now()}`, { cache:"no-store" });
    const data = await res.json();
    if(!data || !data.ok) return;

    const v = data.values || {};
    ME_PUBLIC.enabled = String(v.public_enabled || "").trim() === "true";
    ME_PUBLIC.id = String(v.public_profile_id || "").trim();
    ME_PUBLIC.nickname = String(v.nickname || "").trim();
    ME_PUBLIC.alias = String(v.alias || "").trim();

    // â˜…è‡ªåˆ†ã®ä¾¡å€¤è¦³ï¼ˆæ¯”è¼ƒç”¨ï¼‰
    ME_PUBLIC.q = {};
    for(let i=1;i<=12;i++){
      const k = "q"+i;
      ME_PUBLIC.q[k] = normAns(v[k]);
    }
  }catch(_){}
}

/* è¡¨ç¤ºåï¼ˆæ²ç¤ºæ¿ç”¨ï¼‰ */
function displayName(){
  const nn = (ME_PUBLIC.nickname||"").trim();
  const al = (ME_PUBLIC.alias||"").trim();
  if(al && nn) return `${al} ${nn}`;
  if(nn) return nn;
  return "åŒ¿å";
}

/* è‡ªåˆ†åˆ¤å®šç”¨ï¼špublicProfileIdï¼ˆã‚µãƒ¼ãƒã‹ã‚‰ï¼‰ */
function myPublicId(){
  return (ME_PUBLIC.enabled && ME_PUBLIC.id) ? ME_PUBLIC.id : "";
}

/* =========================
   çŠ¶æ…‹
========================= */
let REPORT_TARGET = null;
let PROFILE_TARGET = null;

async function load(){
  const box = document.getElementById("chat");
  box.innerHTML = `<div class="chatEmpty">èª­ã¿è¾¼ã¿ä¸­â€¦</div>`;

  // âœ… å…ˆã«è‡ªåˆ†ã®å…¬é–‹çŠ¶æ…‹ã‚’ã‚µãƒ¼ãƒã‹ã‚‰åŒæœŸ
  await fetchMyPublic();

  const res = await fetch(`${GAS_URL}?action=list_board&_=${Date.now()}`, { cache:"no-store" });
  const data = await res.json();
  if(!data.ok){
    box.innerHTML = `<div class="chatEmpty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
    return;
  }

  const items = (data.items || []).filter(x => !x.isHidden);
  if(!items.length){
    box.innerHTML = `<div class="chatEmpty">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  const sorted = [...items].sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));

  box.innerHTML = "";
  let lastDay = "";
  const MY_PUBLIC_ID = myPublicId();

  sorted.forEach(x=>{
    const day = fmtDay(x.createdAt);
    if(day && day !== lastDay){
      lastDay = day;
      const sep = document.createElement("div");
      sep.className = "daySep";
      sep.innerHTML = `<span>${esc(day)}</span>`;
      box.appendChild(sep);
    }

    const pub = getPublicIdFromItem(x);
    const isMe = (MY_PUBLIC_ID && pub === MY_PUBLIC_ID);

    const row = document.createElement("div");
    row.className = `row ${isMe ? "me" : "other"}`;

    const clickable = !!pub;

    // è¿”ä¿¡å…ˆè¡¨ç¤ºï¼ˆGASã‹ã‚‰ reply_to_name ãŒè¿”ã£ã¦ãã‚‹æƒ³å®šï¼‰
    const replyHtml = x.reply_to_name ? `
      <div class="replyLine">â†ª è¿”ä¿¡å…ˆï¼š${esc(x.reply_to_name)}</div>
    ` : "";

    row.innerHTML = `
      <div class="bubble">
        ${replyHtml}
        <div class="nameLine">
          <button class="nameBtn ${clickable ? "" : "disabled"}" type="button"
            data-u="${esc(pub)}"
            data-name="${esc(x.name||"åŒ¿å")}"
          >${esc(x.name||"åŒ¿å")}</button>
          <span class="meta">${esc(fmtTime(x.createdAt))}</span>
        </div>
        <div class="text">${esc(x.body)}</div>
        <div class="tools">
          <button class="btn btnMini" type="button"
            data-reply-id="${esc(x.id)}"
            data-reply-name="${esc(x.name||"åŒ¿å")}"
          >è¿”ä¿¡</button>
          <button class="btn btnMini danger" type="button" data-report="${esc(x.id)}">é€šå ±</button>
        </div>
      </div>
    `;

    row.querySelector('[data-report]').onclick = ()=>{
      REPORT_TARGET = x.id;
      document.getElementById("reportReason").value = "";
      document.getElementById("reportBack").style.display="flex";
    };

    box.appendChild(row);
  });

  box.scrollTop = box.scrollHeight;
}

/* =========================
   chatã‚¯ãƒªãƒƒã‚¯ï¼ˆè¿”ä¿¡ / åå‰ã‚¿ãƒƒãƒ—ï¼‰
========================= */
document.getElementById("chat").addEventListener("click", (e)=>{
  // â‘  è¿”ä¿¡ãƒœã‚¿ãƒ³
  const r = e.target.closest("[data-reply-id]");
  if(r){
    const rid = (r.dataset.replyId || "").trim();
    const rname = (r.dataset.replyName || "åŒ¿å").trim();
    if(!rid) return;

    setReplyTo({ id: rid, name: rname });

    // å…¥åŠ›æ¬„ã«è»½ããƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å…¥ã‚Œã‚‹ï¼ˆä»»æ„ï¼‰
    const ta = document.getElementById("body");
    if(!ta.value.startsWith("@"+rname)){
      ta.value = `@${rname} ` + ta.value;
    }
    ta.focus();
    return;
  }

  // â‘¡ åå‰ã‚¿ãƒƒãƒ—ï¼ˆç°¡æ˜“ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰
  const btn = e.target.closest(".nameBtn");
  if(!btn) return;

  const u = (btn.dataset.u || "").trim();
  const display = (btn.dataset.name || btn.textContent || "ãƒ¦ãƒ¼ã‚¶ãƒ¼").trim();

  if(!u){
    toast("ã“ã®æŠ•ç¨¿ã¯å…¬é–‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  openProfileModal(u, display);
});

/* =========================
   post
========================= */
document.getElementById("postBtn").onclick = async ()=>{
  const body = document.getElementById("body").value.trim();
  if(!body){ alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  // âœ… é€ä¿¡ç›´å‰ã«ã‚‚ã‚µãƒ¼ãƒåŒæœŸï¼ˆã“ã“ãŒé‡è¦ï¼‰
  await fetchMyPublic();

  const p = new URLSearchParams();
  p.set("action","add_board");
  p.set("name", displayName());
  p.set("body", body);

  // âœ… å…¬é–‹ONã®æ™‚ã ã‘ã€ã‚µãƒ¼ãƒã® public_profile_id ã‚’è¼‰ã›ã‚‹
  if(ME_PUBLIC.enabled && ME_PUBLIC.id){
    p.set("publicProfileId", ME_PUBLIC.id);
  }

  // â˜…ãƒªãƒ—ãƒ©ã‚¤æƒ…å ±ï¼ˆGASã«ä¿å­˜ã—ã¦list_boardã§è¿”ã™ï¼‰
  if(REPLY_TO && REPLY_TO.id){
    p.set("reply_to_id", REPLY_TO.id);
    p.set("reply_to_name", REPLY_TO.name || "");
  }

  const res = await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body:p.toString()
  });

  const data = await res.json();
  if(data.ok){
    document.getElementById("body").value = "";
    setReplyTo(null);
    await load();
  }else{
    alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
};

/* =========================
   report modal
========================= */
function closeReport(){
  document.getElementById("reportBack").style.display="none";
  REPORT_TARGET = null;
}
document.getElementById("cancelReport").onclick = closeReport;
document.getElementById("closeReport").onclick = closeReport;

document.getElementById("sendReport").onclick = async ()=>{
  if(!REPORT_TARGET) return;

  const reason = document.getElementById("reportReason").value.trim();
  const p = new URLSearchParams();
  p.set("action","report_board");
  p.set("id", REPORT_TARGET);
  p.set("reason", reason);

  await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body:p.toString()
  });

  closeReport();
  toast("é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ");
};

/* =========================
   profile modal
========================= */
function closeProfile(){
  document.getElementById("profileBack").style.display="none";
  PROFILE_TARGET = null;

  // â˜…ãƒãƒ£ãƒ¼ãƒˆç ´æ£„
  if(radarChart){
    radarChart.destroy();
    radarChart = null;
  }
}
document.getElementById("closeProfile").onclick = closeProfile;

document.getElementById("profileBack").addEventListener("click",(e)=>{
  if(e.target.id === "profileBack") closeProfile();
});

/** ä¸€è‡´åº¦ï¼ˆ0 or 100ï¼‰ */
function matchScore(myAns, otherAns){
  const a = normAns(myAns);
  const b = normAns(otherAns);
  if(!a || !b) return 0;
  return a === b ? 100 : 0;
}

function renderRadar(myQ, otherQ){
  const canvas = document.getElementById("valueRadar");
  if(!canvas) return;

  // Chart.js ãŒèª­ã¿è¾¼ã‚ãªã„ç’°å¢ƒå‘ã‘
  if(typeof Chart === "undefined"){
    const ctx2d = canvas.getContext("2d");
    ctx2d.clearRect(0,0,canvas.width,canvas.height);
    ctx2d.font = "14px sans-serif";
    ctx2d.fillText("ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ï¼ˆChart.jsæœªèª­è¾¼ï¼‰", 10, 30);
    return;
  }

  // æ—¢å­˜ç ´æ£„
  if(radarChart){
    radarChart.destroy();
    radarChart = null;
  }

  const labels = Array.from({length:12}, (_,i)=> `ä¾¡å€¤è¦³${i+1}`);

  // è‡ªåˆ†ã¯ â€œåŸºæº–ã¨ã—ã¦100â€
  const meData = labels.map(()=> 100);

  // ç›¸æ‰‹ã¯ â€œä¸€è‡´=100 / ä¸ä¸€è‡´=0â€
  const otherData = labels.map((_,i)=>{
    const k = "q"+(i+1);
    return matchScore(myQ[k], otherQ[k]);
  });

  const ctx = canvas.getContext("2d");

  radarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [
        {
          label: "ã‚ãªãŸï¼ˆåŸºæº–ï¼‰",
          data: meData,
          borderWidth: 2,
          pointRadius: 2,
          fill: false
        },
        {
          label: "ç›¸æ‰‹ï¼ˆä¸€è‡´åº¦ï¼‰",
          data: otherData,
          borderWidth: 2,
          pointRadius: 2,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true }
      },
      scales: {
        r: {
          min: 0,
          max: 100,
          ticks: { stepSize: 50 },
          pointLabels: { font: { size: 11 } }
        }
      }
    }
  });
}

async function openProfileModal(publicId, display){
  PROFILE_TARGET = publicId;

  // å¿µã®ãŸã‚ã€è‡ªåˆ†ã®æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«
  await fetchMyPublic();

  document.getElementById("pmTitle").textContent = `${display} ã®ç°¡æ˜“ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«`;
  const body = document.getElementById("pmBody");
  body.innerHTML = `<div class="item"><span>èª­ã¿è¾¼ã¿ä¸­â€¦</span></div>`;
  document.getElementById("pmBio").textContent = "â€”";
  document.getElementById("profileBack").style.display="flex";

  try{
    const res = await fetch(`${GAS_URL}?action=get_public_profile&u=${encodeURIComponent(publicId)}&_=${Date.now()}`, { cache:"no-store" });
    const data = await res.json();

    if(!data || !data.ok || !data.profile){
      body.innerHTML = `
        <div class="item">
          <b>éå…¬é–‹</b>
          <span>ã“ã®æ–¹ã¯ç¾åœ¨ã€å…¬é–‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’OFFã«ã—ã¦ã„ã¾ã™ã€‚</span>
        </div>
      `;
      renderRadar(ME_PUBLIC.q || {}, {});
      return;
    }

    const p = data.profile || {};
    const nn = [p.alias, p.nickname].filter(Boolean).join(" ").trim() || "â€”";

    // ã²ã¨ã“ã¨ï¼ˆbioï¼‰
    document.getElementById("pmBio").textContent = (normAns(p.bio) || "â€”");

    // ä¸€è‡´æ•°
    let matchCount = 0;
    const otherQ = {};
    for(let i=1;i<=12;i++){
      const k = "q"+i;
      otherQ[k] = normAns(p[k]);
      if(matchScore(ME_PUBLIC.q?.[k], otherQ[k]) === 100) matchCount++;
    }

    body.innerHTML = `
      <div class="item">
        <b>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </b>
        <span>${esc(nn)}</span>
      </div>
      <div class="item">
        <b>ä¾¡å€¤è¦³ã®ä¸€è‡´</b>
        <span>${esc(String(matchCount))} / 12ï¼ˆä¸€è‡´=100ã€ä¸ä¸€è‡´=0ã§è¡¨ç¤ºï¼‰</span>
      </div>
    `;

    // ãƒ¬ãƒ¼ãƒ€ãƒ¼æç”»
    renderRadar(ME_PUBLIC.q || {}, otherQ);

  }catch(e){
    body.innerHTML = `
      <div class="item">
        <b>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</b>
        <span>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</span>
      </div>
    `;
    renderRadar(ME_PUBLIC.q || {}, {});
  }
}

/* start */
load();

/* ä»»æ„ï¼šæ“¬ä¼¼ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ 
setInterval(load, 4000);
*/
</script>
</body>
</html>