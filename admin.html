<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理画面｜セレネス</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;
  background:#fbf6f1;
  color:#3b352e;
}
.wrap{max-width:1200px;margin:auto;padding:20px}
h1{margin:0 0 12px}
.card{
  background:#fff;
  border-radius:20px;
  padding:18px;
  margin-bottom:16px;
  box-shadow:0 12px 24px rgba(0,0,0,.08);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border-bottom:1px solid #eadfce;
  padding:8px;
  text-align:left;
  vertical-align:top;
}
th{background:#f7f1e7}
button{
  padding:8px 12px;
  border:none;
  border-radius:14px;
  background:#c9a36a;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
button.sub{background:#8b7a63}
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  background:#f3e8d8;
  font-size:11px;
  margin-right:4px;
  margin-bottom:4px;
}
.rule-row{
  display:flex;
  gap:12px;
  margin-bottom:10px;
  align-items:center;
  flex-wrap:wrap;
}
.rule-row label{cursor:pointer}
input[type="number"]{width:90px;padding:6px;border:1px solid #eadfce;border-radius:10px}
.small{font-size:12px;color:#7a6f63;line-height:1.7}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:820px){.grid2{grid-template-columns:1fr}}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 10px;border:1px solid #eadfce;border-radius:999px;
  background:#fff;
  font-size:12px;color:#6b5f52;
}
hr.sep{border:none;border-top:1px solid #eadfce;margin:12px 0}
.candBox .candItem{
  border:1px solid #eadfce;
  border-radius:16px;
  padding:10px 12px;
  background:#fff;
  margin:8px 0;
}
.candTop{
  display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.candScores{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;
}
.scorePill{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;
  border:1px solid #eadfce;background:#fff;
  font-size:12px;color:#6b5f52;
}
.scorePill strong{font-size:13px;color:#3b352e}
</style>
</head>

<body>
<div class="wrap">
  <h1>セレネス 管理画面</h1>

  <!-- ① ルール設定 -->
  <div class="card">
    <h2>① 紹介ルール設定（総合スコア式）</h2>

    <div class="rule-row">
      <span class="pill">最低スコア（総合）</span>
      <input id="min_score" type="number" min="0" max="100" value="60">
      <span class="small">（0〜100）</span>
    </div>

    <div class="rule-row">
      <label><input type="checkbox" id="require_opposite_gender"> 性別が異なる人のみ紹介</label>
    </div>

    <div class="rule-row">
      <label><input type="checkbox" id="require_q1"> ①安心感は必須</label>
      <label><input type="checkbox" id="require_q2"> ②金銭感覚は必須</label>
      <label><input type="checkbox" id="exclude_q6_extreme"> ⑥距離感の極端（1×5）を除外</label>
    </div>

    <hr class="sep">

    <h3 style="margin:0 0 8px;font-size:14px">重み（一致/近さの影響度）</h3>
    <div class="grid2">
      <div class="rule-row">
        <span class="pill">w_q1</span><span class="small">①安心感</span>
        <input id="w_q1" type="number" min="0" max="10" value="2">
      </div>
      <div class="rule-row">
        <span class="pill">w_q2</span><span class="small">②金銭感覚</span>
        <input id="w_q2" type="number" min="0" max="10" value="2">
      </div>
      <div class="rule-row">
        <span class="pill">w_q3</span><span class="small">③生活ペース</span>
        <input id="w_q3" type="number" min="0" max="10" value="1">
      </div>
      <div class="rule-row">
        <span class="pill">w_q4</span><span class="small">④会話</span>
        <input id="w_q4" type="number" min="0" max="10" value="1">
      </div>
      <div class="rule-row">
        <span class="pill">w_q5</span><span class="small">⑤将来観</span>
        <input id="w_q5" type="number" min="0" max="10" value="1">
      </div>
      <div class="rule-row">
        <span class="pill">w_q6</span><span class="small">⑥距離感</span>
        <input id="w_q6" type="number" min="0" max="10" value="1">
      </div>
    </div>

    <div class="rule-row" style="margin-top:12px">
      <button onclick="saveRules()">ルールを保存</button>
      <button class="sub" onclick="loadRules()">ルールを再読込</button>
      <span class="small" id="ruleMsg"></span>
    </div>

    <div class="small">
      ※ 総合スコア（total）は、各設問の回答の「近さ」を点数化（同じ=100/差1=70/差2=40/差3=15/それ以上=0）し、重みで平均して0〜100で算出します。<br>
      ※ 未回答の設問はスコア計算から除外されます。<br>
      ※ 価値観一致数（score）は q1〜q6 の完全一致の数です（補助指標）。
    </div>
  </div>

  <!-- ② 会員・価値観一覧（未実施も表示） -->
  <div class="card">
    <h2>② 会員・価値観一覧（未実施も表示）</h2>
    <div class="small" style="margin:0 0 10px">
      「候補を見る」を押すと、その会員の紹介候補（総合スコア順）を表示します。
    </div>

    <table id="valuesTable">
      <thead>
        <tr>
          <th style="width:140px">ID</th>
          <th style="width:160px">名前</th>
          <th style="width:90px">性別</th>
          <th>価値観（①〜⑥）</th>
          <th style="width:120px">候補生成</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ③ 紹介候補 -->
  <div class="card">
    <h2>③ 紹介候補</h2>
    <div id="candidates" class="candBox">
      <div class="small">左の一覧から「候補を見る」を押してください。</div>
    </div>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";

/* ===============================
   ルール読み込み
================================ */
async function loadRules(){
  const msg = document.getElementById("ruleMsg");
  msg.textContent = "読み込み中...";
  try{
    const res = await fetch(`${GAS_URL}?action=get_rules`, { cache:"no-store" });
    const data = await res.json();
    if(!data.ok){ msg.textContent = "読み込み失敗"; return; }

    const r = data.rules || {};

    // 数値系
    document.getElementById("min_score").value = (r.min_score ?? 60);
    document.getElementById("w_q1").value = (r.w_q1 ?? 2);
    document.getElementById("w_q2").value = (r.w_q2 ?? 2);
    document.getElementById("w_q3").value = (r.w_q3 ?? 1);
    document.getElementById("w_q4").value = (r.w_q4 ?? 1);
    document.getElementById("w_q5").value = (r.w_q5 ?? 1);
    document.getElementById("w_q6").value = (r.w_q6 ?? 1);

    // bool系（"true"でもOKに）
    document.getElementById("require_opposite_gender").checked = (r.require_opposite_gender === true || r.require_opposite_gender === "true");
    document.getElementById("require_q1").checked = (r.require_q1 === true || r.require_q1 === "true");
    document.getElementById("require_q2").checked = (r.require_q2 === true || r.require_q2 === "true");
    document.getElementById("exclude_q6_extreme").checked = (r.exclude_q6_extreme === true || r.exclude_q6_extreme === "true");

    msg.textContent = "読み込み完了";
    setTimeout(()=> msg.textContent="", 1200);
  }catch(e){
    console.error(e);
    msg.textContent = "読み込みエラー";
  }
}

/* ===============================
   ルール保存
================================ */
async function saveRules(){
  const msg = document.getElementById("ruleMsg");
  msg.textContent = "保存中...";

  const rules = {
    min_score: Number(document.getElementById("min_score").value || 0),
    require_opposite_gender: document.getElementById("require_opposite_gender").checked,
    require_q1: document.getElementById("require_q1").checked,
    require_q2: document.getElementById("require_q2").checked,
    exclude_q6_extreme: document.getElementById("exclude_q6_extreme").checked,
    w_q1: Number(document.getElementById("w_q1").value || 0),
    w_q2: Number(document.getElementById("w_q2").value || 0),
    w_q3: Number(document.getElementById("w_q3").value || 0),
    w_q4: Number(document.getElementById("w_q4").value || 0),
    w_q5: Number(document.getElementById("w_q5").value || 0),
    w_q6: Number(document.getElementById("w_q6").value || 0),
  };

  try{
    const url = `${GAS_URL}?action=save_rules&data=${encodeURIComponent(JSON.stringify(rules))}&_=${Date.now()}`;
    const res = await fetch(url, { cache:"no-store" });
    const data = await res.json();
    if(data.ok){
      msg.textContent = "保存しました";
      setTimeout(()=> msg.textContent="", 1200);
    }else{
      msg.textContent = "保存失敗";
    }
  }catch(e){
    console.error(e);
    msg.textContent = "保存エラー";
  }
}

/* ===============================
   会員・価値観一覧読み込み（未実施も表示）
================================ */
async function loadValues(){
  const res = await fetch(`${GAS_URL}?action=list_values&_=${Date.now()}`, { cache:"no-store" });
  const data = await res.json();
  if(!data.ok) return;

  const tbody = document.querySelector("#valuesTable tbody");
  tbody.innerHTML = "";

  data.items.forEach(v=>{
    const hasDiag = !!(v.q1 || v.q2 || v.q3 || v.q4 || v.q5 || v.q6);
    const qBadge = hasDiag
      ? `
        <span class="badge">①${escapeHtml(v.q1)}</span>
        <span class="badge">②${escapeHtml(v.q2)}</span>
        <span class="badge">③${escapeHtml(v.q3)}</span>
        <span class="badge">④${escapeHtml(v.q4)}</span>
        <span class="badge">⑤${escapeHtml(v.q5)}</span>
        <span class="badge">⑥${escapeHtml(v.q6)}</span>
      `
      : `<span class="badge">診断未実施</span>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(v.id)}</td>
      <td>${escapeHtml(v.name || "")}</td>
      <td>${escapeHtml(v.gender || "")}</td>
      <td>${qBadge}</td>
      <td>
        <button class="sub" onclick="loadCandidates('${encodeURIComponent(v.id)}')">候補を見る</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===============================
   紹介候補表示（★totalをメイン表示）
================================ */
async function loadCandidates(encodedId){
  const id = decodeURIComponent(encodedId);
  const box = document.getElementById("candidates");
  box.innerHTML = `<div class="small">読み込み中...</div>`;

  const res = await fetch(`${GAS_URL}?action=candidates&id=${encodeURIComponent(id)}&_=${Date.now()}`, { cache:"no-store" });
  const data = await res.json();

  if(!data.ok){
    box.innerHTML = `<div class="small">候補を表示できません（${escapeHtml(data.error||"") }）</div>`;
    return;
  }

  box.innerHTML = `<h3 style="margin:0 0 10px;font-size:14px">${escapeHtml(data.me.name)} さんの候補</h3>`;

  if(!data.candidates || data.candidates.length === 0){
    box.innerHTML += `<div class="small">候補なし（ルールが厳しい / 相手の診断未実施の可能性）</div>`;
    return;
  }

  data.candidates.forEach(c=>{
    // 互換：旧仕様のscoreしか無い場合でも壊れないようにする
    const total = (c.total != null) ? Number(c.total) : null;
    const matchScore = (c.score != null) ? Number(c.score) : null;

    box.innerHTML += `
      <div class="candItem">
        <div class="candTop">
          <div>
            <div><strong>${escapeHtml(c.name)}</strong>（${escapeHtml(c.gender||"")}）</div>
            <div class="small">${(c.matches||[]).map(escapeHtml).join(" / ")}</div>
          </div>

          <div class="candScores">
            <span class="scorePill">総合<strong>${(total==null? "-" : total)}</strong>/100</span>
            <span class="scorePill">価値観一致<strong>${(matchScore==null? "-" : matchScore)}</strong>/6</span>
          </div>
        </div>
      </div>
    `;
  });
}

/* utils */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

/* 初期読み込み */
(async ()=>{
  await loadRules();
  await loadValues();
})();
</script>
</body>
</html>