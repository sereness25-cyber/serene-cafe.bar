<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Master's Deskï½œSereness</title>
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&family=Dancing+Script:wght@600&family=Zen+Kurenaido&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <style>
    :root { 
      --ink:#3e2723; --paper:#fdfbf7; --wood:#5d4037; --accent:#a1887f; --gold:#d4af37; 
      --stamp-red: #d32f2f; --line-color: #aec2d1; 
    }
    body { margin:0; font-family:"Shippori Mincho",serif; color:var(--ink); background-color:#2b1d16; background-image:url('https://www.transparenttextures.com/patterns/wood-pattern.png'); min-height:100vh; }
    .desk-light { position:fixed; top:0; left:50%; transform:translateX(-50%); width:100%; height:600px; background:radial-gradient(circle at 50% 0%,rgba(255,230,200,0.15),transparent 70%); pointer-events:none; z-index:0; }
    
    header { position:sticky; top:0; z-index:100; background:rgba(43,29,22,0.95); border-bottom:1px solid rgba(255,255,255,0.1); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; color:#eaddcf; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
    .brand { font-family:'Dancing Script'; font-size:24px; color:var(--gold); }
    .nav-links a { color:#ccc; text-decoration:none; font-size:13px; margin-left:15px; }
    
    main { position:relative; z-index:1; max-width:1000px; margin:0 auto; padding:30px 20px 100px; }
    
    .desk-tabs { display:flex; gap:4px; padding-left:10px; margin-bottom:-1px; position:relative; z-index:5; overflow-x:auto; white-space:nowrap; scrollbar-width:none; }
    .desk-tabs::-webkit-scrollbar { display:none; }
    .d-tab { padding:10px 20px; background:#3e2e26; color:#998; border-radius:8px 8px 0 0; cursor:pointer; font-size:13px; font-weight:bold; border:1px solid rgba(255,255,255,0.05); border-bottom:none; }
    .d-tab.active { background:var(--paper); color:var(--ink); height:42px; transform:translateY(-4px); box-shadow:0 -2px 5px rgba(0,0,0,0.1); }
    
    .desk-paper { background:var(--paper); padding:40px; border-radius:4px; box-shadow:0 4px 20px rgba(0,0,0,0.15); min-height:600px; position:relative; background-image:url('https://www.transparenttextures.com/patterns/cream-paper.png'); }
    .section { display:none; } .section.active { display:block; }
    h2 { font-size:20px; border-bottom:2px double var(--accent); padding-bottom:10px; margin-top:0; font-family:'Zen Kurenaido'; display:flex; align-items:center; gap:8px; }

    .ledger-book { border: 1px solid #ccc; background: #fff; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); position: relative; min-height: 500px; background-image: linear-gradient(var(--line-color) 1px, transparent 1px); background-size: 100% 40px; background-position: 0 40px; }
    .ledger-header-area { background: #fff; border-bottom: 2px double var(--ink); padding: 20px 30px; display: flex; justify-content: space-between; align-items: flex-end; }
    .ledger-title { font-size: 24px; font-weight: bold; font-family: "Shippori Mincho"; border: 1px solid var(--ink); padding: 5px 15px; display: inline-block; }
    .ledger-month-nav { display: flex; align-items: center; gap: 15px; font-size: 18px; margin-bottom: 10px; }
    .nav-btn { cursor: pointer; user-select: none; font-weight: bold; padding: 0 10px; }
    .nav-btn:hover { color: var(--accent); }
    .ledger-summary { text-align: right; font-size: 13px; color: #666; }
    .sum-val { font-size: 18px; font-weight: bold; color: var(--ink); margin-left: 10px; border-bottom: 1px solid #999; }
    
    .ledger-table-wrap { padding: 0 30px 40px; }
    .ledger-row { display: grid; grid-template-columns: 80px 1fr 90px 80px 100px; height: 40px; align-items: center; font-size: 14px; }
    .l-head { font-weight: bold; font-size: 12px; color: #888; border-bottom: 1px solid var(--line-color); margin-bottom: 0; }
    .l-col { padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .l-amt { text-align: right; font-family: 'Courier New', monospace; font-weight: bold; color: var(--wood); }
    .l-stamp-area { display: flex; justify-content: center; align-items: center; position: relative; }

    .stamp-mark { width: 32px; height: 32px; border: 2px solid var(--stamp-red); border-radius: 50%; color: var(--stamp-red); font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; transform: rotate(-15deg); border: 3px double var(--stamp-red); opacity: 0.8; user-select: none; }
    .stamp-anim { animation: stampIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes stampIn { 0% { transform: scale(2) rotate(10deg); opacity: 0; } 100% { transform: scale(1) rotate(-15deg); opacity: 0.9; } }
    .btn-pay { font-size: 10px; padding: 2px 8px; border: 1px solid #888; background: #fff; color: #333; border-radius: 2px; cursor: pointer; box-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    .btn-pay:hover { background: #eee; }
    .action-icon { cursor: pointer; color: #888; font-size: 16px; margin-left: 6px; transition: 0.2s; }
    .action-icon:hover { color: var(--pri); transform: scale(1.1); }
    .action-icon.del:hover { color: #d32f2f; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-card { background: #fff; padding: 15px; border: 1px solid #eee; text-align: center; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .stat-val { font-size: 24px; font-weight: bold; color: var(--wood); font-family: 'Dancing Script'; margin: 5px 0; }
    .stat-label { font-size: 11px; color: #888; }

    .data-list { display:grid; gap:10px; }
    .letter-card { padding:12px; border:1px solid #d4c5b5; background:#fffcf5; display:flex; justify-content:space-between; align-items:center; border-radius:2px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    .badge { padding:2px 8px; border-radius:4px; font-size:11px; font-weight:bold; margin-right:4px; }
    .status-pending { background:#fff3e0; color:#e65100; border:1px solid #ffb74d; }
    .status-approved { background:#e8f5e9; color:#2e7d32; border:1px solid #a5d6a7; }
    .status-paid { background:#e3f2fd; color:#1565c0; border:1px solid #90caf9; }
    .ng-alert { color: #d32f2f; font-weight: bold; font-size: 11px; display: inline-flex; align-items: center; gap: 4px; margin-left: 8px; }
    
    .l-meta { font-size:12px; color:#888; margin-bottom:8px; display:grid; grid-template-columns:100px 1fr; gap:4px; }
    .bg-green { background:#e8f5e9; color:#2e7d32; border:1px solid #a5d6a7; }
    .bg-red { background:#ffebee; color:#c62828; border:1px solid #ef9a9a; }
    .bg-gray { background:#f0f0f0; color:#666; border:1px solid #ccc; }

    .btn { cursor:pointer; border:none; padding:8px 16px; border-radius:4px; font-size:13px; transition:0.2s; background:var(--wood); color:#fff; }
    .btn-danger { background:#fff; border:1px solid #d32f2f; color:#d32f2f; }
    .btn-success { background:#2e7d32; }
    
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; display:none; justify-content:center; align-items:center; }
    .modal-box { background:#fdfbf7; width:500px; max-width:90%; max-height:90vh; overflow-y:auto; padding:30px; border-radius:2px; }
    .form-control { width:100%; padding:8px; border:1px solid #ccc; box-sizing:border-box; margin-bottom:10px; }
  </style>
</head>
<body>
  <div class="desk-light"></div>
  <header>
    <div class="brand">Master's Desk</div>
    <div class="nav-links"><a href="index.html">Top</a></div>
  </header>
  <main id="mainContent" style="display:none;">
    <div class="desk-tabs">
      <div class="d-tab active" onclick="switchTab('dashboard')">ğŸ“Š åˆ†æ</div>
      <div class="d-tab" onclick="switchTab('members')">ğŸ‘¤ ä¼šå“¡</div>
      <div class="d-tab" onclick="switchTab('letters')">ğŸ“® æ‰‹ç´™</div>
      <div class="d-tab" onclick="switchTab('communities')">ğŸª‘ ãƒ†ãƒ¼ãƒ–ãƒ«</div>
      <div class="d-tab" onclick="switchTab('diaries')">ğŸ“– æ‰‹å¸³</div>
      <div class="d-tab" onclick="switchTab('ledger')">ğŸ’° å¸³ç°¿</div>
      <div class="d-tab" onclick="switchTab('system')">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ </div>
    </div>
    <div class="desk-paper">
      
      <div id="secDashboard" class="section active">
        <h2>åº—èˆ—çŠ¶æ³ (Dashboard)</h2>
        <div class="dashboard-grid">
          <div class="stat-card"><div class="stat-label">ç·ä¼šå“¡æ•°</div><div class="stat-val" id="stMembers">-</div></div>
          <div class="stat-card"><div class="stat-label">ç”·æ€§ / å¥³æ€§</div><div class="stat-val" id="stGender">-</div></div>
          <div class="stat-card"><div class="stat-label">æ‰‹ç´™æµé€šæ•°</div><div class="stat-val" id="stLetters">-</div></div>
          <div class="stat-card"><div class="stat-label">å£²ä¸Šç›®å®‰</div><div class="stat-val" id="stSales">-</div></div>
          <div class="stat-card"><div class="stat-label">å‡çµä¸­</div><div class="stat-val" id="stBanned">-</div></div>
        </div>
      </div>

      <div id="secMembers" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h2 style="margin:0; border:none; padding:0;">ä¼šå“¡å°å¸³</h2>
          <button class="btn" style="background:#5a3e32; font-size:12px;" onclick="document.getElementById('bcBody').focus(); switchTab('system');">ğŸ“¢ å…¨å“¡ã«é€šçŸ¥ã™ã‚‹</button>
        </div>
        <input type="text" id="searchMember" class="form-control" placeholder="æ¤œç´¢..." onkeyup="renderMembers()">
        <div class="data-list" id="memberList">Loading...</div>
      </div>

      <div id="secLetters" class="section">
        <h2>æ‰‹ç´™ã®æ¤œé–²ãƒ»é…é”</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
          <input type="text" id="searchLetter" class="form-control" placeholder="åå‰ã§æ¤œç´¢..." onkeyup="renderLetters()" style="margin-bottom:0; flex:1;">
          <button class="btn btn-sm" style="background:#ccc;color:#333;width:auto;" onclick="filterLetters('all')">å…¨ä»¶</button>
          <button class="btn btn-sm status-pending" style="width:auto;" onclick="filterLetters('pending')">æœªæ‰¿èª</button>
          <button class="btn btn-sm status-approved" style="width:auto;" onclick="filterLetters('approved')">æ‰¿èªæ¸ˆã¿</button>
        </div>
        <div id="letterList">Loading...</div>
      </div>

      <div id="secCommunities" class="section">
        <h2>ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼‰ç®¡ç†</h2>
        <div id="adminCommList" class="data-list">Loading...</div>
      </div>

      <div id="secBoard" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px double var(--accent); padding-bottom:10px; margin-bottom: 15px;">
           <h2 style="border:none; padding:0; margin:0;">ãƒ†ãƒ¼ãƒ–ãƒ«å†… ç›£è¦–</h2>
           <button class="btn" style="background:#ccc; color:#333; padding:4px 10px;" onclick="switchTab('communities')">â—€ ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã«æˆ»ã‚‹</button>
        </div>
        <div id="boardFilterArea" style="margin-bottom: 15px; background: #fff3e0; padding: 10px; border-left: 4px solid #e65100; border-radius: 2px;">
           <span style="font-size: 12px; color: #888;">è¡¨ç¤ºä¸­ã®ãƒ†ãƒ¼ãƒ–ãƒ«: </span>
           <span id="boardFilterName" style="font-weight:bold; color:var(--ink); font-size: 14px;"></span>
        </div>
        <div id="adminBoardList" class="data-list">Loading...</div>
      </div>

      <div id="secDiaries" class="section">
        <h2>æ‰‹å¸³ï¼ˆæ—¥è¨˜ï¼‰ç®¡ç†</h2>
        <div id="adminDiaryList" class="data-list">Loading...</div>
      </div>

      <div id="secLedger" class="section">
        <div class="ledger-book">
          <div class="ledger-header-area">
            <div>
              <div class="ledger-month-nav">
                <span class="nav-btn" onclick="changeMonth(-1)">ï¼œ</span>
                <span id="ledgerTitleYearMonth">2023å¹´ 10æœˆ</span>
                <span class="nav-btn" onclick="changeMonth(1)">ï¼</span>
              </div>
              <div class="ledger-title">å£²ä¸Šå‡ºç´å¸³</div>
            </div>
            <div class="ledger-summary">
              <div>æœªåé¡: <span id="sumUnpaid" style="color:#d32f2f;">Â¥0</span></div>
              <div>å›åæ¸ˆ: <span id="sumPaid" class="sum-val">Â¥0</span></div>
            </div>
          </div>
          <div class="ledger-table-wrap">
            <div class="ledger-row l-head">
              <div class="l-col">æ—¥ä»˜</div>
              <div class="l-col">æ‘˜è¦ (From â†’ To)</div>
              <div class="l-col l-amt">é‡‘é¡</div>
              <div class="l-col" style="text-align:center;">å—é ˜å°</div>
              <div class="l-col" style="text-align:right;">æ“ä½œ</div>
            </div>
            <div id="ledgerRows"></div>
          </div>
        </div>
      </div>

      <div id="secSystem" class="section">
        <h2>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
        <div class="data-item" style="display:block;">
          <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ“¢ å…¨å“¡ã«é€šçŸ¥ (Broadcast)</label>
          <textarea id="bcBody" class="form-control" placeholder="å…¨å“¡ã®éƒµä¾¿å—ã‘ã«å±ŠããŠçŸ¥ã‚‰ã›ã‚’å…¥åŠ›..." style="height:120px;"></textarea>
          <button class="btn btn-success" onclick="broadcastLetter()">å…¨ä¼šå“¡ã«é€ä¿¡</button>
        </div>
      </div>

    </div>
  </main>

  <div id="loginModal" class="modal-overlay" style="display:flex;">
    <div class="modal-box" style="width:300px; text-align:center;">
      <h3>Master Login</h3>
      <input type="password" id="adminPass" class="form-control" placeholder="Password" style="margin-bottom:20px;" onkeydown="if(event.key==='Enter') adminLogin()">
      <button class="btn btn-success" onclick="adminLogin()">Enter</button>
    </div>
  </div>

  <div id="letterModal" class="modal-overlay">
    <div class="modal-box">
      <h3>æ‰‹ç´™ã®ç¢ºèª</h3>
      <div class="l-meta">
        <div>From:</div><div id="mFrom"></div>
        <div>To:</div><div id="mTo"></div>
      </div>
      <div style="background:#fff; padding:10px; border:1px dashed #ccc; margin:10px 0; max-height:200px; overflow-y:auto; white-space:pre-wrap;" id="mBody"></div>
      <label style="font-size:12px;">æ¨è–¦ã‚³ãƒ¡ãƒ³ãƒˆ</label>
      <textarea id="mComment" class="form-control" style="height:60px;"></textarea>
      <div style="margin-top:20px; display:flex; justify-content:space-between;">
        <button class="btn btn-danger" onclick="rejectLetter()">å´ä¸‹</button>
        <button class="btn btn-success" onclick="approveLetter()">æ‰¿èª</button>
      </div>
      <input type="hidden" id="mLetterId">
    </div>
  </div>

  <div id="notifyModal" class="modal-overlay">
    <div class="modal-box">
      <h3>å€‹åˆ¥é€šçŸ¥ã‚’é€ã‚‹</h3>
      <div style="margin-bottom:15px; font-size:14px;">
        To: <b id="notifyTargetName"></b> <span style="font-size:12px; color:#888;" id="notifyTargetId"></span>
      </div>
      <label style="font-size:12px;color:#888;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹</label>
      <textarea id="notifyBody" class="form-control" style="height:150px;" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
      
      <div style="display:flex; justify-content:space-between; margin-top:20px;">
        <button class="btn" onclick="document.getElementById('notifyModal').style.display='none'" style="background:#ccc; color:#333;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-success" onclick="execNotify()">é€ä¿¡ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="memberEditModal" class="modal-overlay">
    <div class="modal-box">
      <h3>ä¼šå“¡ç·¨é›†</h3>
      <div style="text-align:center; margin-bottom:15px;">
        <img id="edAvatar" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid #ccc; background:#eee;">
      </div>
      <label style="font-size:12px;color:#888;">ID</label>
      <input id="edId" class="form-control" readonly style="background:#eee;">
      <label style="font-size:12px;color:#888;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
      <input id="edName" class="form-control">
      <label style="font-size:12px;color:#888;">å¹´é½¢ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
      <input id="edAge" class="form-control" readonly style="background:#eee;">
      <label style="font-size:12px;color:#888;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ (applications & profilesé€£æº)</label>
      <select id="edStatus" class="form-control">
        <option value="approved">approved (æ‰¿èªæ¸ˆãƒ»é€šå¸¸)</option>
        <option value="pending">pending (æœªæ‰¿èªãƒ»å¯©æŸ»ä¸­)</option>
        <option value="left">left (é€€åº—ãƒ»é€€ä¼šæ¸ˆ)</option>
      </select>
      <label style="font-size:12px;color:#888; color:#d32f2f; font-weight:bold; margin-top:10px;">å¹´é½¢ç¢ºèª (è¨˜éŒ²)</label>
      <select id="edAgeVerified" class="form-control" style="border:1px solid #d32f2f; background:#fffcfc;">
        <option value="false">æœªç¢ºèª</option>
        <option value="true">ç¢ºèªæ¸ˆã¿ (Verified)</option>
      </select>
      <div style="display:flex; justify-content:space-between; margin-top:20px;">
        <button class="btn btn-danger" onclick="deleteMem()">å®Œå…¨å‰Šé™¤</button>
        <button class="btn btn-success" onclick="saveMem()">ä¿å­˜</button>
      </div>
      <button class="btn" onclick="document.getElementById('memberEditModal').style.display='none'" style="margin-top:10px; background:#ccc; width:100%;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="communityEditModal" class="modal-overlay">
    <div class="modal-box">
      <h3>ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†</h3>
      <label style="font-size:12px;color:#888;">ãƒ†ãƒ¼ãƒ–ãƒ«å</label>
      <input id="edCommTitle" class="form-control">
      <label style="font-size:12px;color:#888;">èª¬æ˜</label>
      <textarea id="edCommDesc" class="form-control" style="height:80px;"></textarea>
      <input type="hidden" id="edCommId">
      <div style="display:flex; justify-content:space-between; margin-top:20px;">
        <button class="btn" onclick="closeModal('communityEditModal')" style="background:#ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-success" onclick="saveCommunity()">ä¿å­˜</button>
      </div>
    </div>
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbx79zOLPWQ85wu_qS4uWAsDJKV8uWr35eLK21IaHd6jfe6XRS1Di-nCudb45t5eaEy-GA/exec";
  let allLetters = [], allMembers = [], allCommunities = [];
  let filterStat = 'all';
  let ledgerYear = new Date().getFullYear();
  let ledgerMonth = new Date().getMonth();

  function adminLogin() {
    const p = document.getElementById("adminPass").value;
    if(p === "admin") { 
      document.getElementById("loginModal").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      init();
    } else { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); }
  }

  async function api(act, p={}) {
    const u = new URL(GAS_URL);
    u.searchParams.append("action", act);
    u.searchParams.append("_nc", Date.now()); 
    for(let k in p) u.searchParams.append(k, p[k]);
    try { const res = await fetch(u); return await res.json(); } catch(e){ return {ok:false}; }
  }

  function init(){
    loadDashboard();
    loadMembers();
    loadLetters();
    loadCommunities(); 
  }

  function switchTab(t) {
    document.querySelectorAll('.d-tab').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
    
    const tabMap = {dashboard:0, members:1, letters:2, communities:3, diaries:4, ledger:5, system:6};
    
    if (t === 'board') {
        document.querySelectorAll('.d-tab')[tabMap['communities']].classList.add('active');
        document.getElementById('secBoard').classList.add('active');
    } else {
        if (tabMap[t] !== undefined) {
            document.querySelectorAll('.d-tab')[tabMap[t]].classList.add('active');
        }
        document.getElementById('sec'+t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
    }
    
    if(t==='ledger') renderLedgerBook(); 
    if(t==='communities') loadCommunities();
    if(t==='diaries') loadDiaries();
  }

  async function loadDashboard() {
    const res = await api("get_dashboard_data");
    if(res.ok) {
        let s = res.stats || {};
        let membersObj = s.members || {};
        let lettersObj = s.letters || {};
        let salesObj = s.sales || {};

        let mem = typeof membersObj === 'object' ? (membersObj.total || 0) : (s.members || 0);
        let male = typeof membersObj === 'object' ? (membersObj.male || 0) : (s.male || 0);
        let female = typeof membersObj === 'object' ? (membersObj.female || 0) : (s.female || 0);
        let banned = typeof membersObj === 'object' ? (membersObj.banned || 0) : (s.banned || 0);
        
        let letNum = typeof lettersObj === 'object' ? (lettersObj.total || 0) : (s.letters || 0);
        let salNum = typeof salesObj === 'object' ? (salesObj.total || 0) : (s.sales || 0);

        document.getElementById("stMembers").textContent = mem + "å";
        document.getElementById("stGender").textContent = male + " / " + female;
        document.getElementById("stLetters").textContent = letNum + "é€š";
        document.getElementById("stSales").textContent = "Â¥" + salNum.toLocaleString();
        document.getElementById("stBanned").textContent = banned + "å";
    }
  }

  /* --- Members --- */
  async function loadMembers() {
    const res = await api("list_members_all");
    if(res.ok) { allMembers = res.members; renderMembers(); }
  }
  
  function calcAge(bstr) {
      if(!bstr) return "æœªç™»éŒ²";
      const b = new Date(bstr);
      const today = new Date();
      let age = today.getFullYear() - b.getFullYear();
      const mDiff = today.getMonth() - b.getMonth();
      if (mDiff < 0 || (mDiff === 0 && today.getDate() < b.getDate())) { age--; }
      return isNaN(age) ? "æœªç™»éŒ²" : age + "æ­³";
  }

  function renderMembers() {
    const term = document.getElementById("searchMember").value.toLowerCase();
    const el = document.getElementById("memberList"); el.innerHTML="";
    allMembers.forEach(m=>{
      if(term && !m.nickname.toLowerCase().includes(term) && !m.memberId.toLowerCase().includes(term)) return;
      let stBadge = `<span class="badge bg-gray">${escapeHtml(m.status)}</span>`;
      if(m.status === 'left') stBadge = '<span class="badge bg-gray">é€€åº—æ¸ˆ</span>';
      else if(m.status === 'approved' || m.status === 'active') stBadge = '<span class="badge bg-green">æ‰¿èªæ¸ˆ</span>';
      else if(m.status === 'pending') stBadge = '<span class="badge status-pending">æœªæ‰¿èª</span>';
      
      const ver = (m.ageVerified === "true" || m.ageVerified === true) ? '<span class="badge bg-green">å¹´é½¢æ¸ˆ</span>' : '<span class="badge bg-gray">å¹´é½¢æœª</span>';
      const ageText = calcAge(m.birthdate);

      el.innerHTML += `
        <div class="letter-card">
          <div>
            ${stBadge} ${ver} <b>${escapeHtml(m.nickname)}</b> <span style="font-size:11px;color:#888;">(${ageText} / ID: ${m.memberId})</span>
          </div>
          <div style="display:flex; gap:6px;">
            <button class="btn" style="padding:4px 10px; font-size:11px; background:#5a3e32;" onclick="openNotify('${m.memberId}', '${escapeHtml(m.nickname)}')">âœ‰ï¸ é€šçŸ¥</button>
            <button class="btn btn-danger" style="padding:4px 10px; font-size:11px;" onclick="editMem('${m.memberId}')">ç·¨é›†</button>
          </div>
        </div>`;
    });
  }

  function openNotify(id, name) {
    document.getElementById("notifyTargetId").textContent = id;
    document.getElementById("notifyTargetName").textContent = name;
    document.getElementById("notifyBody").value = "";
    document.getElementById("notifyModal").style.display = "flex";
  }

  async function execNotify() {
    const id = document.getElementById("notifyTargetId").textContent;
    const name = document.getElementById("notifyTargetName").textContent;
    const body = document.getElementById("notifyBody").value;
    
    if(!body) return alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if(!confirm(`${name} ã•ã‚“ã«é€šçŸ¥ã‚’é€ã‚Šã¾ã™ã‹ï¼Ÿ`)) return;

    // â˜… ä¿®æ­£: é€ä¿¡è€…åã‚’ã€Œãƒã‚¹ã‚¿ãƒ¼ã€ã«å¤‰æ›´
    const res = await api("send_letter", {
      fromMemberId: "MASTER",
      fromName: "ãƒã‚¹ã‚¿ãƒ¼", // ã“ã“ã‚’ä¿®æ­£
      toMemberId: id,
      toName: name,
      body: body,
      status: "approved", 
      giftFlower: "Message", 
      paperType: "classic",
      waxColor: "wax-gold",
      sealMark: "star"
    });

    if(res.ok) {
      alert("é€ä¿¡ã—ã¾ã—ãŸ");
      closeModal("notifyModal");
    } else {
      alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    }
  }

  function editMem(id) {
    const m = allMembers.find(x=>x.memberId===id);
    document.getElementById("edId").value = m.memberId;
    document.getElementById("edName").value = m.nickname;
    document.getElementById("edAvatar").src = m.avatarDataUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    document.getElementById("edAge").value = calcAge(m.birthdate);
    let st = m.status || "approved";
    if (st === "active") st = "approved";
    document.getElementById("edStatus").value = st;
    document.getElementById("edAgeVerified").value = (m.ageVerified === "true" || m.ageVerified === true) ? "true" : "false";
    document.getElementById("memberEditModal").style.display="flex";
  }
  async function saveMem() {
    await api("update_profile", { 
        memberId: document.getElementById("edId").value, 
        nickname: document.getElementById("edName").value,
        status: document.getElementById("edStatus").value,
        ageVerified: document.getElementById("edAgeVerified").value
    });
    closeModal("memberEditModal"); loadMembers();
  }
  async function deleteMem() {
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    await api("delete_member", { memberId: document.getElementById("edId").value });
    closeModal("memberEditModal"); loadMembers();
  }

  /* --- Letters --- */
  async function loadLetters() {
    const res = await api("list_letters_all");
    if(res.ok) { allLetters = res.letters; renderLetters(); renderLedgerBook(); loadDashboard(); }
  }
  function renderLetters() {
    const term = document.getElementById("searchLetter").value.toLowerCase();
    const el = document.getElementById("letterList"); el.innerHTML = "";
    const sorted = allLetters.slice().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    sorted.forEach(l=>{
      if((filterStat !== 'all' && l.status !== filterStat) && !(filterStat==='matched' && l.status.includes('matched'))) return;
      if(term && !l.fromName.toLowerCase().includes(term) && !l.toName.toLowerCase().includes(term)) return;
      let st = `<span class="badge status-pending">æ‰¿èªå¾…ã¡</span>`;
      if(l.status==='approved') st = `<span class="badge status-approved">æ‰¿èªæ¸ˆã¿</span>`;
      if(l.status.includes('matched')) st = `<span class="badge status-paid">ãƒãƒƒãƒ</span>`;
      let alertMsg = l.hasNg ? `<span class="ng-alert"><span class="material-icons-outlined" style="font-size:14px;">warning</span> NGæ¤œçŸ¥</span>` : "";
      el.innerHTML += `
        <div class="letter-card">
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <div>${st} ${alertMsg}</div><span style="font-size:10px; color:#888;">${new Date(l.createdAt).toLocaleString()}</span>
            </div>
            <div class="l-meta"><span>From:</span><b>${escapeHtml(l.fromName)}</b> <span>To:</span><b>${escapeHtml(l.toName)}</b></div>
            <div style="font-size:12px; color:#666;">${escapeHtml(l.body||"").substring(0,40)}...</div>
          </div>
          <div style="margin-left:10px;">
            <button class="btn btn-success" style="padding:4px 8px;margin-bottom:4px;" onclick="openLetter('${l.id}')">ç¢ºèª</button>
            <button class="btn btn-danger" style="padding:4px 8px;" onclick="deleteLet('${l.id}')">å‰Šé™¤</button>
          </div>
        </div>`;
    });
  }
  function filterLetters(s) { filterStat=s; renderLetters(); }
  function openLetter(id) {
    const l = allLetters.find(x=>x.id===id);
    document.getElementById("mLetterId").value = l.id;
    document.getElementById("mFrom").textContent = l.fromName;
    document.getElementById("mTo").textContent = l.toName;
    document.getElementById("mBody").textContent = l.body;
    document.getElementById("letterModal").style.display="flex";
  }
  async function approveLetter() {
    if(!confirm("æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ")) return;
    await api("update_letter_status", { id:document.getElementById("mLetterId").value, status:"approved", adminComment:document.getElementById("mComment").value });
    closeModal('letterModal'); loadLetters(); 
  }
  async function rejectLetter() { deleteLet(document.getElementById("mLetterId").value); closeModal('letterModal'); }
  
  async function deleteLet(id) {
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    await api("delete_letter", { id: id }); 
    loadLetters();
  }

  /* --- Communities (ãƒ†ãƒ¼ãƒ–ãƒ«) --- */
  async function loadCommunities() {
    const res = await api("list_communities");
    if(res.ok) {
        allCommunities = res.communities;
        const el = document.getElementById("adminCommList"); el.innerHTML = "";
        res.communities.forEach(c => {
            el.innerHTML += `
            <div class="letter-card" style="display:block; margin-bottom:10px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <b style="color:var(--pri);">${escapeHtml(c.title)}</b> 
                <span style="font-size:10px; color:#888;">${new Date(c.createdAt).toLocaleString()}</span>
              </div>
              <div style="font-size:13px; margin-bottom:5px; white-space:pre-wrap;">${escapeHtml(c.description)}</div>
              <div style="font-size:11px; color:#888; margin-bottom:5px;">ä½œæˆè€…ID: ${escapeHtml(c.createdBy)} / å‚åŠ äººæ•°: ${c.memberCount}å</div>
              
              <div style="text-align:right; margin-top:10px; display:flex; justify-content:flex-end; gap:5px;">
                <button class="btn" style="padding:4px 8px; font-size:11px; background:#457b9d;" onclick="viewCommunityBoard('${c.id}', '${escapeHtml(c.title)}')">ä¸­ã‚’è¦‹ã‚‹ï¼ˆæŠ•ç¨¿ä¸€è¦§ï¼‰</button>
                <button class="btn btn-success" style="padding:4px 8px; font-size:11px;" onclick="editCommunity('${c.id}')">ç·¨é›†</button>
                <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;" onclick="deleteAdminCommunity('${c.id}')">å‰Šé™¤</button>
              </div>
            </div>`;
        });
        if(res.communities.length === 0) el.innerHTML = "<p>ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>";
    }
  }
  
  function editCommunity(id) {
      const c = allCommunities.find(x => x.id === id);
      if(!c) return;
      document.getElementById("edCommId").value = c.id;
      document.getElementById("edCommTitle").value = c.title;
      document.getElementById("edCommDesc").value = c.description;
      document.getElementById("communityEditModal").style.display = "flex";
  }

  async function saveCommunity() {
      const id = document.getElementById("edCommId").value;
      const title = document.getElementById("edCommTitle").value.trim();
      const desc = document.getElementById("edCommDesc").value.trim();
      if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      
      const res = await api("update_community", { communityId: id, title: title, description: desc });
      if(res.ok) { closeModal("communityEditModal"); loadCommunities(); } 
      else { alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
  }

  function viewCommunityBoard(id, title) {
      switchTab('board'); loadBoard(id, title);
  }

  async function deleteAdminCommunity(id) {
      if(!confirm("ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®æŠ•ç¨¿ã¯æ®‹ã‚Šã¾ã™ãŒã€ä¸€è¦§ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚")) return;
      await api("delete_community", { communityId: id });
      loadCommunities();
  }

  /* --- Board (ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ä¸­èº«) --- */
  async function loadBoard(filterCommId = "", filterCommTitle = "") {
    if(!filterCommId) return; 
    
    document.getElementById("adminBoardList").innerHTML = "Loading...";
    const filterName = document.getElementById("boardFilterName");
    filterName.textContent = filterCommTitle;

    const res = await api("list_posts", { limit: 100, isAdmin: "true" });
    if(res.ok) {
        const el = document.getElementById("adminBoardList"); el.innerHTML = "";
        let count = 0;
        
        res.posts.forEach(p => {
            if(p.communityId !== filterCommId) return; 
            count++;

            let reps = p.replies.map(r => `<div style="margin-left:10px; font-size:11px; color:#666; border-left:1px solid #ccc; padding-left:5px; margin-top:2px;">â”” ${escapeHtml(r.userProfile.nickname)}: ${escapeHtml(r.body)}</div>`).join("");
            
            el.innerHTML += `
            <div class="letter-card" style="display:block; margin-bottom:10px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <b style="color:var(--pri);">${escapeHtml(p.title)}</b> 
                <span style="font-size:10px; color:#888;">${new Date(p.createdAt).toLocaleString()}</span>
              </div>
              <div style="font-size:13px; margin-bottom:5px; white-space:pre-wrap;">${escapeHtml(p.body)}</div>
              <div style="font-size:11px; color:#888; margin-bottom:5px;">æŠ•ç¨¿è€…: ${escapeHtml(p.userProfile.nickname)} (ID: ${p.lineUserId})</div>
              ${reps}
              <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;" onclick="deleteAdminPost('${p.id}', '${filterCommId}', '${filterCommTitle}')">æŠ•ç¨¿ã‚’å‰Šé™¤</button>
              </div>
            </div>`;
        });
        if(count === 0) el.innerHTML = "<p>ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>";
    }
  }

  async function deleteAdminPost(id, filterCommId, filterCommTitle) {
      if(!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await api("delete_post", { postId: id });
      loadBoard(filterCommId, filterCommTitle);
  }

  /* --- Diaries --- */
  async function loadDiaries() {
    const res = await api("list_diaries", { limit: 100, isAdmin: "true" });
    if(res.ok) {
        const el = document.getElementById("adminDiaryList"); el.innerHTML = "";
        res.diaries.forEach(d => {
            let img = d.imageSrc ? `<img src="${d.imageSrc}" style="max-height:100px; max-width:100px; display:block; margin:5px 0; border:1px solid #ccc;">` : "";
            el.innerHTML += `
            <div class="letter-card" style="display:block; margin-bottom:10px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <b style="color:var(--pri);">${escapeHtml(d.title)}</b> 
                <span class="badge ${d.privacy==='public'?'bg-green':'bg-gray'}">${d.privacy}</span>
              </div>
              <div style="font-size:11px; color:#888;">${d.date} / åŸ·ç­†è€…ID: ${d.memberId}</div>
              ${img}
              <div style="font-size:13px; margin-top:8px; white-space:pre-wrap;">${escapeHtml(d.body)}</div>
              <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;" onclick="deleteAdminDiary('${d.id}')">å‰Šé™¤</button>
              </div>
            </div>`;
        });
        if(res.diaries.length === 0) el.innerHTML = "<p>æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“</p>";
    }
  }
  async function deleteAdminDiary(id) {
      if(!confirm("ã“ã®æ—¥è¨˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await api("delete_diary", { diaryId: id });
      loadDiaries();
  }

  /* --- Ledger --- */
  function changeMonth(d) {
    let dt = new Date(ledgerYear, ledgerMonth + d, 1);
    ledgerYear = dt.getFullYear(); ledgerMonth = dt.getMonth();
    renderLedgerBook();
  }
  function renderLedgerBook() {
    const el = document.getElementById("ledgerRows"); el.innerHTML = "";
    document.getElementById("ledgerTitleYearMonth").textContent = `${ledgerYear}å¹´ ${ledgerMonth+1}æœˆ`;
    const targets = allLetters.filter(l => {
        if(!l.status.includes('matched')) return false;
        const d = new Date(l.createdAt); return d.getFullYear() === ledgerYear && d.getMonth() === ledgerMonth;
    }).sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));

    let sumPaid = 0; let sumUnpaid = 0;
    if(targets.length === 0) { el.innerHTML = `<div style="padding:20px; text-align:center; color:#ccc;">å–å¼•ãªã—</div>`; } 
    else {
        targets.forEach(l => {
            const date = new Date(l.createdAt).getDate();
            const isPaid = (l.status === 'matched_paid');
            const price = l.price !== undefined && l.price !== "" ? Number(l.price) : 5000; 
            
            if(isPaid) sumPaid += price; else sumUnpaid += price;
            let actionHtml = `<button class="btn-pay" onclick="stampPay('${l.id}')">å…¥é‡‘ç¢ºèª</button>`;
            if(isPaid) actionHtml = `<div class="stamp-mark">å—é ˜</div>`;
            
            let opHtml = `
              <div style="display:flex; gap:4px; justify-content:flex-end;">
                <button class="btn" style="padding:2px 6px; font-size:10px; background:#888;" onclick="editLedgerPrice('${l.id}', ${price})">ç·¨é›†</button>
                <button class="btn btn-danger" style="padding:2px 6px; font-size:10px;" onclick="deleteLedgerItem('${l.id}')">å‰Šé™¤</button>
              </div>
            `;

            el.innerHTML += `
              <div class="ledger-row" id="row-${l.id}">
                <div class="l-col">${ledgerMonth+1}/${date}</div>
                <div class="l-col" style="font-size:12px;">${escapeHtml(l.fromName)} â†’ ${escapeHtml(l.toName)}</div>
                <div class="l-col l-amt">Â¥${price.toLocaleString()}</div>
                <div class="l-stamp-area">${actionHtml}</div>
                <div class="l-col" style="text-align:right;">${opHtml}</div>
              </div>`;
        });
    }
    document.getElementById("sumPaid").textContent = `Â¥${sumPaid.toLocaleString()}`;
    document.getElementById("sumUnpaid").textContent = `Â¥${sumUnpaid.toLocaleString()}`;
  }
  
  async function stampPay(id) {
    if(!confirm("å…¥é‡‘ã‚’ç¢ºèªã—ã¾ã—ãŸã‹ï¼Ÿ\nãƒãƒ³ã‚³ã‚’æŠ¼ã—ã¾ã™ã€‚")) return;
    const res = await api("update_letter_status", { id: id, status: "matched_paid" });
    if(res.ok) {
        document.getElementById(`row-${id}`).querySelector(".l-stamp-area").innerHTML = `<div class="stamp-mark stamp-anim">å—é ˜</div>`;
        loadLetters(); 
    }
  }

  async function editLedgerPrice(id, currentPrice) {
      const newPriceStr = prompt("æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆåŠè§’æ•°å­—ï¼‰", currentPrice);
      if(newPriceStr === null) return;
      const newPrice = parseInt(newPriceStr, 10);
      if(isNaN(newPrice)) return alert("æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      
      const res = await api("update_letter_price", { id: id, price: newPrice });
      if(res.ok) { loadLetters(); } 
      else { alert("é‡‘é¡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
  }

  async function deleteLedgerItem(id) {
      if(!confirm("ã“ã®å–å¼•ï¼ˆæ‰‹ç´™ã®ã‚„ã‚Šå–ã‚Šï¼‰ã‚’å¸³ç°¿ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      const res = await api("delete_letter", { id: id });
      if(res.ok) { 
          loadLetters(); 
      } else {
          alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
  }

  async function broadcastLetter() {
    const body = document.getElementById("bcBody").value;
    if(!body) return alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if(!confirm("å…¨ä¼šå“¡ã®ãƒã‚¹ãƒˆã«æ‰‹ç´™ã‚’é€ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    const res = await api("broadcast_letter", { body: body });
    if(res.ok) { alert(res.count + "é€šé€ä¿¡ã—ã¾ã—ãŸ"); document.getElementById("bcBody").value = ""; } else { alert("é€ä¿¡å¤±æ•—"); }
  }

  function closeModal(id) { document.getElementById(id).style.display="none"; }
  function escapeHtml(s) { return s ? String(s).replace(/&/g, "&amp;") : ""; }
</script>
</body>
</html>