<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>管理者｜申請・承認・ID発行</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script defer src="liff-config.js"></script>
  <script defer src="app.js"></script>

  <style>
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{padding:10px 12px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer}
    .tab.active{background:var(--pri-soft);border-color:#f2c7b6}
    .table{width:100%;border-collapse:collapse;background:#fffdfb;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .table th,.table td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:top}
    .table th{background:#fff3ec;color:#5a3e32;font-weight:900}
    .table tr:last-child td{border-bottom:none}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;font-size:12px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
    .muted{color:var(--muted)}
    .dangerBox{background:#fff1f1;border:1px solid #fecaca;border-radius:12px;padding:12px}
    .okBox{background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:12px}
    .rowEnd{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    textarea{width:100%;min-height:180px;border:1px solid var(--line);border-radius:12px;padding:12px}
    input[type="text"], input[type="number"]{width:100%}
    .mini{font-size:12px}
    .grid2{display:grid;gap:12px}
    @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr;} }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brand">管理者｜申請・承認・ID発行</div>
    <nav>
      <a class="btn ghost" href="index.html">ホーム</a>
      <a class="btn ghost" href="waiting.html">審査中ページ</a>
      <a class="btn ghost" href="login.html">ログイン</a>
      <span data-auth class="row"></span>
    </nav>
  </div>
</header>

<main>
  <h1>管理者ページ</h1>

  <section class="card">
    <h2>管理者チェック</h2>
    <div id="guardMsg" class="item">チェック中…</div>

    <div class="grid cols2" style="margin-top:10px">
      <div class="item">
        <div style="font-weight:900">方法A：LINE userId の許可リスト（おすすめ）</div>
        <div class="small">あなたの userId を ADMIN_LINE_USER_IDS に入れてください。</div>
        <div class="mono">ADMIN_LINE_USER_IDS = ["Uxxxxxxxx..."]</div>
      </div>
      <div class="item">
        <div style="font-weight:900">方法B：管理PIN（予備）</div>
        <div class="row">
          <input id="pinInput" placeholder="管理PIN" />
          <button class="btn primary" id="btnPin">PINで入る</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnSetPin">PINを設定/変更</button>
          <button class="btn" id="btnClearPin">PINを削除</button>
        </div>
        <p class="small">※PINはこの端末のlocalStorageに保存されます（簡易版）。</p>
      </div>
    </div>
  </section>

  <section class="card" id="adminArea" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">申請・承認</h2>
      <div class="row">
        <button class="btn" id="btnRefresh">更新</button>
        <button class="btn" id="btnExport">JSONエクスポート</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="pending">申請中</button>
      <button class="tab" data-tab="approved">承認済み</button>
      <button class="tab" data-tab="tools">ツール</button>
    </div>

    <!-- 申請中 -->
    <div id="panel-pending">
      <div class="row" style="margin-bottom:10px">
        <input id="qPending" style="flex:1" placeholder="検索：名前 / LINE表示名 / 電話 / userId" />
      </div>
      <div class="item" style="overflow:auto">
        <table class="table" id="tblPending"></table>
      </div>
      <p class="small" style="margin-top:10px">
        ※承認すると <span class="pill">SRN-1234</span> と PIN を発行し、送信用メッセージが生成されます（コピーしてLINEで送ってください）。
      </p>
    </div>

    <!-- 承認済み -->
    <div id="panel-approved" style="display:none">
      <div class="row" style="margin-bottom:10px">
        <input id="qApproved" style="flex:1" placeholder="検索：会員ID / 名前 / LINE表示名 / userId" />
      </div>
      <div class="item" style="overflow:auto">
        <table class="table" id="tblApproved"></table>
      </div>
    </div>

    <!-- ツール -->
    <div id="panel-tools" style="display:none">
      <div class="grid2">
        <div class="item">
          <div style="font-weight:900">ID採番の設定</div>
          <div class="small">次の会員IDの番号（4桁）を変更できます。</div>
          <div class="row" style="margin-top:10px">
            <input id="nextNo" type="number" min="1" placeholder="例：1" style="flex:1" />
            <button class="btn" id="btnSaveNo">保存</button>
          </div>
          <div class="small" id="noHint" style="margin-top:8px"></div>

          <div class="hr"></div>
          <div style="font-weight:900">エクスポート（バックアップ）</div>
          <textarea id="exportBox" readonly placeholder="ここにJSONが出ます"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnCopy">コピー</button>
            <button class="btn" id="btnDownload">download.json</button>
          </div>
        </div>

        <div class="dangerBox">
          <div style="font-weight:900">危険操作</div>
          <p class="small">削除は取り消せません（localStorageから消えます）。</p>
          <div class="row">
            <button class="btn" id="btnClearPending">申請中を全削除</button>
            <button class="btn" id="btnClearApproved">承認済みを全削除</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnClearAll">全部初期化</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 承認モーダル -->
    <dialog id="dlgApprove" style="border:none;border-radius:16px;max-width:760px;width:96%;">
      <form method="dialog">
        <h3 style="margin:0 0 10px">面談完了 → 承認してID発行</h3>
        <div class="okBox">
          <div class="small">
            ここで <b>会員ID（SRN-1234）</b> と <b>PIN</b> を発行します。<br>
            生成された「送信用メッセージ」をコピーして、担当者がLINEで送ってください。
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div class="item">
            <div style="font-weight:900">申請者情報</div>
            <div id="apInfo" class="small"></div>
            <div class="hr"></div>

            <label>会員ID（自動）</label>
            <input id="apMemberId" />

            <label style="margin-top:10px">PIN（4桁）</label>
            <input id="apPin" inputmode="numeric" />

            <div class="rowEnd" style="margin-top:12px">
              <button class="btn" id="btnGenPin" type="button">PIN再生成</button>
              <button class="btn" id="btnGenId" type="button">ID再生成</button>
            </div>
          </div>

          <div class="item">
            <div style="font-weight:900">送信用メッセージ（コピーして送る）</div>
            <textarea id="apMsg" readonly></textarea>
            <div class="rowEnd" style="margin-top:10px">
              <button class="btn" id="btnCopyMsg" type="button">メッセージコピー</button>
            </div>

            <div class="hr"></div>
            <div class="rowEnd">
              <button class="btn" value="cancel" type="submit">キャンセル</button>
              <button class="btn primary" id="btnApproveDo" value="ok" type="submit">承認して保存</button>
            </div>
            <p class="small" style="margin-top:8px">
              ※「承認して保存」後、申請は承認済みに移動します。
            </p>
          </div>
        </div>
      </form>
    </dialog>

  </section>

<script>
/* =====================
   管理者ガード
===================== */
const ADMIN_LINE_USER_IDS = [
  // "Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
];

const K_ADMIN_PIN = "ma_admin_pin";
const K_ADMIN_OK  = "ma_admin_ok";

function isAdminByLine(){
  const s = getLineSession();
  if(!s) return false;
  return ADMIN_LINE_USER_IDS.includes(s.lineUserId);
}
function isAdminByPin(){ return localStorage.getItem(K_ADMIN_OK) === "1"; }
function setAdminOk(){ localStorage.setItem(K_ADMIN_OK, "1"); }
function clearAdminOk(){ localStorage.removeItem(K_ADMIN_OK); }

function setGuard(ok, text){
  document.getElementById("guardMsg").textContent = text;
  document.getElementById("adminArea").style.display = ok ? "block" : "none";
}

function getPin(){ return localStorage.getItem(K_ADMIN_PIN) || ""; }
function setPin(pin){ localStorage.setItem(K_ADMIN_PIN, pin); }
function clearPin(){ localStorage.removeItem(K_ADMIN_PIN); clearAdminOk(); }

function checkGuard(){
  const s = getLineSession();
  if(!s){
    setGuard(false, "ログインが必要です。先に login.html でLINEログインしてください。");
    return;
  }
  if(isAdminByLine() || isAdminByPin()){
    setGuard(true, "管理者としてログイン済みです。");
    renderAll();
    return;
  }
  setGuard(false, "管理者権限がありません。ADMIN_LINE_USER_IDS に追加するか、管理PINで入ってください。");
}

/* =====================
   データ
===================== */
const K_APPLY = "ma_applications";   // { [lineUserId]: {..., status:"pending"} }
const K_APPROVED = "ma_approved";    // { [lineUserId]: {status:"approved", memberId, pin, ...} }
const K_NEXT_NO = "ma_next_member_no"; // number

function loadObj(key, def){ return load(key, def); }
function saveObj(key, val){ save(key, val); }

function listPending(){
  const all = loadObj(K_APPLY, {});
  return Object.values(all).filter(x=>x && x.status==="pending");
}
function listApproved(){
  const all = loadObj(K_APPROVED, {});
  return Object.values(all).filter(x=>x && x.status==="approved");
}

function removePending(lineUserId){
  const all = loadObj(K_APPLY, {});
  delete all[lineUserId];
  saveObj(K_APPLY, all);
}
function addApproved(rec){
  const all = loadObj(K_APPROVED, {});
  all[rec.lineUserId] = rec;
  saveObj(K_APPROVED, all);
}

function getNextNo(){
  const n = parseInt(localStorage.getItem(K_NEXT_NO) || "1", 10);
  return Number.isFinite(n) && n>0 ? n : 1;
}
function setNextNo(n){ localStorage.setItem(K_NEXT_NO, String(n)); }

function pad4(n){ return String(n).padStart(4,"0"); }
function genMemberId(){
  const n = getNextNo();
  return `SRN-${pad4(n)}`;
}
function bumpNo(){
  const n = getNextNo();
  setNextNo(n+1);
}
function genPin(){
  const n = Math.floor(1000 + Math.random()*9000);
  return String(n);
}

function escape(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function makeSendMessage(app, memberId, pin){
  return `【セレネス｜面談完了のお知らせ】
${app.displayName ? `LINE表示名：${app.displayName}\n` : ""}${app.name ? `お名前：${app.name}\n` : ""}

本人確認が完了しましたので、会員IDを発行しました。
下記でログインしてご利用を開始できます。

会員ID：${memberId}
PIN：${pin}

ログイン：${location.origin}${location.pathname.replace(/\/[^\/]+$/, "/")}login.html

【ご利用開始までの流れ】
1) LINEでログイン
2) 会員IDとPINを入力
3) 会員ページ・掲示板が利用可能になります

安心してご利用いただくために、面談で本人確認後にID発行としております。
ご不明点があればこのLINEでお気軽にどうぞ。`;
}

/* =====================
   レンダリング
===================== */
let currentApproveApp = null;

function renderPending(){
  const q = (document.getElementById("qPending").value || "").trim().toLowerCase();
  const rows = listPending().sort((a,b)=> (b.appliedAt||"").localeCompare(a.appliedAt||""))
    .filter(a=>{
      if(!q) return true;
      const blob = `${a.displayName||""} ${a.name||""} ${a.phone||""} ${a.lineUserId||""}`.toLowerCase();
      return blob.includes(q);
    });

  const t = document.getElementById("tblPending");
  t.innerHTML = `
    <tr>
      <th>申請者</th>
      <th>連絡先</th>
      <th class="mono">lineUserId</th>
      <th>申請日時</th>
      <th>操作</th>
    </tr>
    ${rows.map(a=>`
      <tr>
        <td>
          <div><span class="pill">${escape(a.displayName || "LINE")}</span></div>
          <div class="mini">名前：${escape(a.name||"")}</div>
          <div class="mini">年齢：${escape(a.age||"")}</div>
        </td>
        <td>
          <div>電話：${escape(a.phone||"")}</div>
        </td>
        <td class="mono">${escape(a.lineUserId||"")}</td>
        <td class="mono">${escape(a.appliedAt||"")}</td>
        <td>
          <div class="row" style="gap:8px">
            <button class="btn primary" data-approve="${escape(a.lineUserId)}">面談完了→承認</button>
            <button class="btn" data-reject="${escape(a.lineUserId)}">却下/取り下げ</button>
          </div>
        </td>
      </tr>
    `).join("")}
  `;

  t.querySelectorAll("[data-approve]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.getAttribute("data-approve");
      openApprove(id);
    });
  });
  t.querySelectorAll("[data-reject]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.getAttribute("data-reject");
      if(!confirm("この申請を取り下げ/却下として削除しますか？")) return;
      removePending(id);
      renderPending();
    });
  });
}

function renderApproved(){
  const q = (document.getElementById("qApproved").value || "").trim().toLowerCase();
  const rows = listApproved().sort((a,b)=> (b.issuedAt||"").localeCompare(a.issuedAt||""))
    .filter(a=>{
      if(!q) return true;
      const blob = `${a.memberId||""} ${a.displayName||""} ${a.name||""} ${a.lineUserId||""}`.toLowerCase();
      return blob.includes(q);
    });

  const t = document.getElementById("tblApproved");
  t.innerHTML = `
    <tr>
      <th>会員ID</th>
      <th>会員</th>
      <th class="mono">lineUserId</th>
      <th>発行日時</th>
      <th>操作</th>
    </tr>
    ${rows.map(a=>`
      <tr>
        <td><span class="pill"><b>${escape(a.memberId||"")}</b></span></td>
        <td>
          <div><span class="pill">${escape(a.displayName||"LINE")}</span></div>
          <div class="mini">名前：${escape(a.name||"")}</div>
        </td>
        <td class="mono">${escape(a.lineUserId||"")}</td>
        <td class="mono">${escape(a.issuedAt||"")}</td>
        <td>
          <button class="btn" data-copy="${escape(a.lineUserId)}">送信用メッセージ生成</button>
        </td>
      </tr>
    `).join("")}
  `;

  t.querySelectorAll("[data-copy]").forEach(b=>{
    b.addEventListener("click", async ()=>{
      const lineUserId = b.getAttribute("data-copy");
      const all = loadObj(K_APPROVED, {});
      const rec = all[lineUserId];
      if(!rec) return;
      const text = makeSendMessage(rec, rec.memberId, rec.pin);
      await navigator.clipboard.writeText(text);
      alert("送信用メッセージをコピーしました（LINEで貼り付けて送ってください）");
    });
  });
}

function renderAll(){
  renderPending();
  renderApproved();
  document.getElementById("noHint").textContent = `次の会員ID：SRN-${pad4(getNextNo())}`;
}

/* =====================
   承認モーダル
===================== */
function openApprove(lineUserId){
  const all = loadObj(K_APPLY, {});
  const app = all[lineUserId];
  if(!app) return;

  currentApproveApp = app;

  const memberId = genMemberId();
  const pin = genPin();

  document.getElementById("apInfo").innerHTML = `
    <div>LINE表示名：<b>${escape(app.displayName||"")}</b></div>
    <div>名前：<b>${escape(app.name||"")}</b>　年齢：<b>${escape(app.age||"")}</b></div>
    <div>電話：<b>${escape(app.phone||"")}</b></div>
    <div class="mono" style="margin-top:6px">lineUserId：${escape(app.lineUserId||"")}</div>
    <div class="mono">申請日時：${escape(app.appliedAt||"")}</div>
  `;

  document.getElementById("apMemberId").value = memberId;
  document.getElementById("apPin").value = pin;
  document.getElementById("apMsg").value = makeSendMessage(app, memberId, pin);

  document.getElementById("dlgApprove").showModal();
}

function refreshApproveMsg(){
  const memberId = document.getElementById("apMemberId").value.trim();
  const pin = document.getElementById("apPin").value.trim();
  document.getElementById("apMsg").value = makeSendMessage(currentApproveApp, memberId, pin);
}

/* =====================
   タブ・ツール
===================== */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  ["pending","approved","tools"].forEach(k=>{
    document.getElementById("panel-"+k).style.display = (k===name) ? "block" : "none";
  });
}

function makeExport(){
  const data = {
    exportedAt: nowISO(),
    applications: loadObj(K_APPLY, {}),
    approved: loadObj(K_APPROVED, {}),
    nextMemberNo: getNextNo()
  };
  return JSON.stringify(data, null, 2);
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* =====================
   init
===================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  // 検索
  document.getElementById("qPending").addEventListener("input", renderPending);
  document.getElementById("qApproved").addEventListener("input", renderApproved);

  // tabs
  document.getElementById("tabs").addEventListener("click", (e)=>{
    const b = e.target.closest(".tab");
    if(!b) return;
    setTab(b.dataset.tab);
  });

  // 更新・エクスポ
  document.getElementById("btnRefresh").addEventListener("click", renderAll);
  document.getElementById("btnExport").addEventListener("click", ()=>{
    setTab("tools");
    document.getElementById("exportBox").value = makeExport();
  });

  document.getElementById("btnCopy").addEventListener("click", async ()=>{
    const text = document.getElementById("exportBox").value;
    if(!text) return alert("先にエクスポートしてください");
    await navigator.clipboard.writeText(text);
    alert("コピーしました");
  });
  document.getElementById("btnDownload").addEventListener("click", ()=>{
    const text = document.getElementById("exportBox").value;
    if(!text) return alert("先にエクスポートしてください");
    downloadText("sereness-admin-backup.json", text);
  });

  // 次番号
  document.getElementById("noHint").textContent = `次の会員ID：SRN-${pad4(getNextNo())}`;
  document.getElementById("nextNo").value = getNextNo();
  document.getElementById("btnSaveNo").addEventListener("click", ()=>{
    const n = parseInt(document.getElementById("nextNo").value, 10);
    if(!Number.isFinite(n) || n<1) return alert("1以上の数値を入れてください");
    setNextNo(n);
    alert("保存しました");
    document.getElementById("noHint").textContent = `次の会員ID：SRN-${pad4(getNextNo())}`;
  });

  // 危険操作
  document.getElementById("btnClearPending").addEventListener("click", ()=>{
    if(!confirm("申請中を全削除しますか？")) return;
    saveObj(K_APPLY, {});
    renderPending();
  });
  document.getElementById("btnClearApproved").addEventListener("click", ()=>{
    if(!confirm("承認済みを全削除しますか？")) return;
    saveObj(K_APPROVED, {});
    renderApproved();
  });
  document.getElementById("btnClearAll").addEventListener("click", ()=>{
    if(!confirm("全部初期化しますか？（申請/承認/次番号/セッション等）")) return;
    saveObj(K_APPLY, {});
    saveObj(K_APPROVED, {});
    localStorage.removeItem(K_NEXT_NO);
    localStorage.removeItem("ma_session");
    localStorage.removeItem("ma_member_session");
    alert("初期化しました");
    location.replace("index.html");
  });

  // 承認モーダル操作
  document.getElementById("btnGenPin").addEventListener("click", ()=>{
    document.getElementById("apPin").value = genPin();
    refreshApproveMsg();
  });
  document.getElementById("btnGenId").addEventListener("click", ()=>{
    document.getElementById("apMemberId").value = genMemberId();
    refreshApproveMsg();
  });
  document.getElementById("apMemberId").addEventListener("input", refreshApproveMsg);
  document.getElementById("apPin").addEventListener("input", refreshApproveMsg);

  document.getElementById("btnCopyMsg").addEventListener("click", async ()=>{
    const text = document.getElementById("apMsg").value;
    await navigator.clipboard.writeText(text);
    alert("コピーしました（LINEで貼り付けて送ってください）");
  });

  // 「承認して保存」＝dialog submit(ok)
  document.getElementById("dlgApprove").addEventListener("close", ()=>{
    // closeのみ（submit結果はフォーム側で処理したいがdialog標準が薄いのでここは使わない）
  });

  // 実際の承認保存（dialogの「承認して保存」ボタンが押された時）
  document.getElementById("btnApproveDo").addEventListener("click", ()=>{
    if(!currentApproveApp) return;

    const memberId = document.getElementById("apMemberId").value.trim();
    const pin = document.getElementById("apPin").value.trim();

    if(!/^SRN-\d{4}$/.test(memberId)){
      alert("会員IDは SRN-1234 の形式にしてください");
      return;
    }
    if(!/^\d{4}$/.test(pin)){
      alert("PINは4桁で入力してください");
      return;
    }

    // 承認レコード保存
    const rec = {
      status:"approved",
      lineUserId: currentApproveApp.lineUserId,
      displayName: currentApproveApp.displayName || "",
      name: currentApproveApp.name || "",
      age: currentApproveApp.age || "",
      phone: currentApproveApp.phone || "",
      memberId,
      pin,
      issuedAt: nowISO()
    };
    addApproved(rec);

    // 申請から削除（承認済みへ移動）
    removePending(currentApproveApp.lineUserId);

    // 採番を進める（memberIdが自動生成IDだった場合も、手動でも“次へ進む”でOK）
    // 次番号が同じままだと連番が詰まるので進める
    bumpNo();
    document.getElementById("nextNo").value = getNextNo();
    document.getElementById("noHint").textContent = `次の会員ID：SRN-${pad4(getNextNo())}`;

    alert("承認して保存しました。送信用メッセージをコピーしてLINEで送ってください。");
    currentApproveApp = null;
    // dialogは自動で閉じる（form method=dialog）
  });

  // 管理PIN
  document.getElementById("btnPin").addEventListener("click", ()=>{
    const pin = document.getElementById("pinInput").value.trim();
    const saved = getPin();
    if(!saved) return alert("まだPINが設定されていません。先にPINを設定してください。");
    if(pin === saved){
      setAdminOk();
      alert("PIN認証OK");
      checkGuard();
    }else{
      alert("PINが違います");
    }
  });
  document.getElementById("btnSetPin").addEventListener("click", ()=>{
    const pin = prompt("新しい管理PIN（4桁以上推奨）");
    if(!pin) return;
    setPin(pin.trim());
    alert("PINを設定しました");
  });
  document.getElementById("btnClearPin").addEventListener("click", ()=>{
    if(!confirm("管理PINを削除しますか？")) return;
    clearPin();
    alert("PINを削除しました");
    checkGuard();
  });

  // guard
  checkGuard();
});
</script>
</main>
</body>
</html>